/**
 * @preserve
 * Kontra.js v10.0.0
 */
let t=()=>{};let e,i,s={};function a(t,e){s[t]=s[t]||[],s[t].push(e)}function r(t,...e){(s[t]||[]).map((t=>t(...e)))}let n={get:(e,i)=>"_proxy"==i||t};function h(){return e}function o(){return i}class c{constructor(t=0,e=0,i={}){null!=t.x?(this.x=t.x,this.y=t.y):(this.x=t,this.y=e)}set(t){this.x=t.x,this.y=t.y}add(t){return new c(this.x+t.x,this.y+t.y,this)}}class l{constructor(t){return this.init(t)}init(t={}){this.position=function(){return new c(...arguments)}(),Object.assign(this,t)}update(t){this.advance(t)}advance(t){}_pc(){}}class d extends l{init({width:t=0,height:e=0,context:i=o(),render:s=this.draw,update:r=this.advance,children:n=[],anchor:h={x:0,y:0},opacity:c=1,scaleX:l=1,scaleY:d=1,...u}={}){this._c=[],super.init({width:t,height:e,context:i,anchor:h,opacity:c,scaleX:l,scaleY:d,...u}),this._di=!0,this._uw(),this.addChild(n),this._rf=s,this._uf=r,a("init",(()=>{this.context??=o()}))}update(t){this._uf(t),this.children.map((e=>e.update&&e.update(t)))}render(){let t=this.context;t.save(),(this.x||this.y)&&t.translate(this.x,this.y),1==this.scaleX&&1==this.scaleY||t.scale(this.scaleX,this.scaleY);let e=this.width,i=this.height;this.radius&&(e=i=2*this.radius);let s=-e*this.anchor.x,a=-i*this.anchor.y;(s||a)&&t.translate(s,a),this.context.globalAlpha=this.opacity,this._rf(),(s||a)&&t.translate(-s,-a),this.children.map((t=>t.render&&t.render())),t.restore()}draw(){}_pc(){this._uw(),this.children.map((t=>t._pc()))}get x(){return this.position.x}get y(){return this.position.y}set x(t){this.position.x=t,this._pc()}set y(t){this.position.y=t,this._pc()}get width(){return this._w}set width(t){this._w=t,this._pc()}get height(){return this._h}set height(t){this._h=t,this._pc()}_uw(){if(!this._di)return;let{_wx:t=0,_wy:e=0,_wo:i=1,_wsx:s=1,_wsy:a=1}=this.parent||{};this._wx=this.x,this._wy=this.y,this._ww=this.width,this._wh=this.height,this.radius&&(this._wrx=this.radius,this._wry=this.radius),this._wo=i*this.opacity,this._wsx=s*this.scaleX,this._wsy=a*this.scaleY,this._wx=this._wx*s,this._wy=this._wy*a,this._ww=this.width*this._wsx,this._wh=this.height*this._wsy,this.radius&&(this._wrx=this.radius*this._wsx,this._wry=this.radius*this._wsy),this._wx+=t,this._wy+=e}get world(){return{x:this._wx,y:this._wy,width:this._ww,height:this._wh,radius:this.radius?{x:this._wrx,y:this._wry}:void 0,opacity:this._wo,scaleX:this._wsx,scaleY:this._wsy}}set children(t){this.removeChild(this._c),this.addChild(t)}get children(){return this._c}addChild(...e){e.flat().map((e=>{this.children.push(e),e.parent=this,e._pc=e._pc||t,e._pc()}))}removeChild(...t){t.flat().map((t=>{(function(t,e){let i=t.indexOf(e);if(-1!=i)return t.splice(i,1),!0})(this.children,t)&&(t.parent=null,t._pc())}))}get radius(){return this._r}set radius(t){this._r=t,this._pc()}get opacity(){return this._opa}set opacity(t){this._opa=function(t,e,i){return Math.min(Math.max(t,i),e)}(0,1,t),this._pc()}setScale(t,e=t){this.scaleX=t,this.scaleY=e}get scaleX(){return this._scx}set scaleX(t){this._scx=t,this._pc()}get scaleY(){return this._scy}set scaleY(t){this._scy=t,this._pc()}}class u extends d{init({...t}={}){super.init({...t})}draw(){if(this.color){if(this.context.fillStyle=this.color,this.radius)return this.context.beginPath(),this.context.arc(this.radius,this.radius,this.radius,0,2*Math.PI),void this.context.fill();this.context.fillRect(0,0,this.width,this.height)}}}function p(){return new u(...arguments)}let f=/(\d+)(\w+)/;class w extends d{init({text:t="",textAlign:e="",lineHeight:i=1,font:s=o()?.font,...r}={}){t=""+t,super.init({text:t,textAlign:e,lineHeight:i,font:s,...r}),this.context&&this._p(),a("init",(()=>{this.font??=o().font,this._p()}))}get width(){return this._w}set width(t){this._d=!0,this._w=t,this._fw=t}get text(){return this._t}set text(t){this._d=!0,this._t=""+t}get font(){return this._f}set font(t){this._d=!0,this._f=t,this._fs=function(t){if(!t)return{computed:0};let e=t.match(f),i=+e[1];return{size:i,unit:e[2],computed:i}}(t).computed}get lineHeight(){return this._lh}set lineHeight(t){this._d=!0,this._lh=t}render(){this._d&&this._p(),super.render()}_p(){this._s=[],this._d=!1;let t=this.context,e=[this.text];if(t.font=this.font,e=this.text.split("\n"),!this._s.length&&this.text.includes("\n")){let i=0;e.map((e=>{this._s.push(e),i=Math.max(i,t.measureText(e).width)})),this._w=this._fw||i}this._s.length||(this._s.push(this.text),this._w=this._fw||t.measureText(this.text).width),this.height=this._fs+(this._s.length-1)*this._fs*this.lineHeight,this._uw()}draw(){let t=0,e=this.textAlign,i=this.context;t="right"==e?this.width:"center"==e?this.width/2|0:0,this._s.map(((s,a)=>{i.textBaseline="top",i.textAlign=e,i.fillStyle=this.color,i.font=this.font,i.fillText(s,t,this._fs*this.lineHeight*a)}))}}function y(){return new w(...arguments)}function x(t){let e=t.canvas;t.clearRect(0,0,e.width,e.height)}let b="#AD5F52",g="#913636",m="#E1C584",v="#C89660",O="#B0B17C",T="#6B7F5C",P="#345644",I="#A17D5E",k="#89542F",E="#692F11",C="#64988e",_="#3d7085",R="#B4A18F",A="#796E63",D="#0F2C2E",N="#ECDDBA";function M(t,e,i,s,a){let r=e.split(" ").reduce(((t,e,i,s)=>(i%2==0&&t.push({x:parseFloat(e),y:parseFloat(s[i+1])}),t)),[]);t.beginPath(),t.moveTo(r[0].x+(s??0),r[0].y+(a??0));for(let n=1;n<r.length;n++)t.lineTo(r[n].x+(s??0),r[n].y+(a??0));t.closePath(),t.fillStyle=i,t.fill(),t.closePath()}function S(t,e,i,s,a,r,n,h){t.beginPath(),t.rect(e+0,i+0,s,a),t.fillStyle=r,t.fill(),t.closePath()}let B="s",j="s_f",L="i_u",H="e_d",G="u_t_c",Y="u_t_i",$="u_t_w",W="g_o",F="t_a",X="t_b_e";var U;let K;!function(t){t[t.UP=0]="UP",t[t.DOWN=1]="DOWN",t[t.LEFT=2]="LEFT",t[t.RIGHT=3]="RIGHT"}(U||(U={}));let z=(...t)=>{let{music:e}=ht.getInstance();e&&V(q(...t))},V=(...t)=>{K||(K=new AudioContext);let e=K.createBufferSource(),i=K.createBuffer(t.length,t[0].length,J);return t.map(((t,e)=>i.getChannelData(e).set(t))),e.buffer=i,e.connect(K.destination),e.start(),e},q=(t=1,e=.05,i=220,s=0,a=0,r=.1,n=0,h=1,o=0,c=0,l=0,d=0,u=0,p=0,f=0,w=0,y=0,x=1,b=0,g=0)=>{let m,v,O=2*Math.PI,T=o*=500*O/J**2,P=(0<f?1:-1)*O/4,I=i*=(1+2*e*Math.random()-e)*O/J,k=[],E=0,C=0,_=0,R=1,A=0,D=0,N=0;for(c*=500*O/J**3,f*=O/J,l*=O/J,d*=J,u=J*u|0,v=(s=99+J*s)+(b*=J)+(a*=J)+(r*=J)+(y*=J)|0;_<v;k[_++]=N)++D%(100*w|0)||(N=n?1<n?2<n?3<n?Math.sin((E%O)**3):Math.max(Math.min(Math.tan(E),1),-1):1-(2*E/O%2+2)%2:1-4*Math.abs(Math.round(E/O)-E/O):Math.sin(E),N=(u?1-g+g*Math.sin(2*Math.PI*_/u):1)*(0<N?1:-1)*Math.abs(N)**h*t*Z*(_<s?_/s:_<s+b?1-(_-s)/b*(1-x):_<s+b+a?x:_<v-y?(v-_-y)/r*x:0),N=y?N/2+(y>_?0:(_<v-y?1:(v-_)/y)*k[_-y|0]/2):N),m=(i+=o+=c)*Math.sin(C*f-P),E+=m-m*p*(1-1e9*(Math.sin(_)+1)%2),C+=m-m*p*(1-1e9*(Math.sin(_)**2+1)%2),R&&++R>d&&(i+=l,I+=l,R=0),!u||++A%u||(i=I,o=T,R=R||1);return k},Z=.3,J=44100,Q=[[[1.5,0,400],[1.5,0,4e3,,,.03,2,1.25,,,,,.02,6.8,-.3,,.5],[1.5,0,360,,,.12,2,2,,,,,,9,,.1]],[[[2,-1,20,,,,,,,,20,,,,,,,,],[1,1,,,20,,20,,,,,,20,,20,,,,],[,,12,,12,12,15,,15,15,8,,8,8,10,12,13,12]],[[2,-1,20,,,,,,,,20,,,,,,,,],[1,1,,,20,,20,,,,,,20,,20,,,,],[,,12,,12,12,15,,15,17,8,,8,8,10,11,13,12]],[[2,-1,20,,,,,,,,20,,,,,,,,,,],[1,1,,,20,,20,,,,,,20,,20,,,,,,],[,,12,,12,12,15,,15,15,20,,,,,,,,,,]]],[0,1,0,2],64];class tt{constructor(t){Object.defineProperty(this,"options",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"startX",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"startY",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"threshold",{enumerable:!0,configurable:!0,writable:!0,value:50}),this.addEventListeners()}addEventListeners(){window.addEventListener("touchstart",this.onStart.bind(this)),window.addEventListener("touchend",this.onEnd.bind(this)),window.addEventListener("touchmove",this.preventDefault.bind(this))}onStart(t){let e=this.getPoint(t);this.startX=e.clientX,this.startY=e.clientY}onEnd(t){let e=this.getPoint(t),i=e.clientX-this.startX,s=e.clientY-this.startY;Math.abs(i)>Math.abs(s)&&Math.abs(i)>this.threshold?i>0?this.options.onSwipeRight?.():this.options.onSwipeLeft?.():Math.abs(s)>this.threshold&&(s>0?this.options.onSwipeDown?.():this.options.onSwipeUp?.())}getPoint(t){return t instanceof TouchEvent?t.changedTouches[0]:t}preventDefault(t){t.preventDefault()}}let et=[3,,179,,.03,.06,,2.8,,,,,,.5,25,,,.46,.05],it=t=>[.4,,t?100:50,,.3,.4,1,.1,,,t?50:20,,.09,,,,,.5,.2],st=[3,,576,,,.007,1,.6,,,-273,,,,,,,.64],at=[,0,350,,.3,.4,,3,,,-65,,.1,,,,,.7];var rt,nt;!function(t){t[t.PROLOGUE=0]="PROLOGUE",t[t.INIT=1]="INIT",t[t.IDLE=2]="IDLE",t[t.SWIPING=3]="SWIPING",t[t.GAME_OVER=4]="GAME_OVER"}(rt||(rt={})),function(t){t.KNIGHT="Knight",t.WIZARD="Wizard",t.DEFENDER="Defender"}(nt||(nt={}));class ht{get level(){return Math.floor(this.moveCount/5)}get isWizard(){return this.cls===nt.WIZARD}get isKnight(){return this.cls===nt.KNIGHT}get isDefender(){return this.cls===nt.DEFENDER}constructor(){Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:rt.PROLOGUE}),Object.defineProperty(this,"moveCount",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"music",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"currentItems",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"cls",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"speed",{enumerable:!0,configurable:!0,writable:!0,value:1}),new tt({onSwipeLeft:this.swipe.bind(this,U.LEFT),onSwipeRight:this.swipe.bind(this,U.RIGHT),onSwipeUp:this.swipe.bind(this,U.UP),onSwipeDown:this.swipe.bind(this,U.DOWN)}),window.addEventListener("keydown",(t=>{["ArrowLeft","a"].includes(t.key)&&this.swipe(U.LEFT),["ArrowRight","d"].includes(t.key)&&this.swipe(U.RIGHT),["ArrowUp","w"].includes(t.key)&&this.swipe(U.UP),["ArrowDown","s"].includes(t.key)&&this.swipe(U.DOWN)})),a(j,(()=>{this.state!==rt.GAME_OVER&&(this.state=rt.IDLE)}))}static getInstance(){return ht.instance||(ht.instance=new ht),ht.instance}setClass(t){this.cls=t,r(G,t),this.state=rt.IDLE}toggleBGM(){this.music?(this.music.stop(),this.music=null):(this.music=V(...((t,e,i,s=125)=>{let a,r,n,h,o,c,l,d,u,p,f,w,y,x,b=0,g=[],m=[],v=[],O=0,T=0,P=1,I={},k=J/s*60>>2;for(;P;O++)g=[P=d=w=0],i.map(((s,E)=>{for(l=e[s][O]||[0,0,0],P|=!!e[s][O],x=w+(e[s][0].length-2-!d)*k,y=E==i.length-1,r=2,h=w;r<l.length+y;d=++r){for(o=l[r],u=r==l.length+y-1&&y||p!=(l[0]||0)|o,n=0;n<k&&d;n++>k-99&&u?f+=(f<1)/99:0)c=(1-f)*g[b++]/2||0,m[h]=(m[h]||0)-c*T+c,v[h]=(v[h++]||0)+c*T+c;o&&(f=o%1,T=l[1]||0,(o|=0)&&(g=I[[p=l[b=0]||0,o]]=I[[p,o]]||(a=[...t[p]],a[2]*=2**((o-12)/12),o>0?q(...a):[])))}w=x}));return[m,v]})(...Q)),this.music.loop=!0)}toggleSpeed(){this.speed=1===this.speed?1.5:1.5===this.speed?2:1}swipe(t){this.state===rt.IDLE&&(this.moveCount++,this.state=rt.SWIPING,z(...st),r(B,t))}addItems(t){t.forEach((t=>{this.isDefender&&(t.duration=Math.min(6,t.duration)),this.currentItems.push(t)})),r(L,t,[])}removeItems(t){let e=this.currentItems.filter((e=>!t.includes(e)));this.currentItems=e,r(L,[],t)}gameOver(){this.state=rt.GAME_OVER,this.music?.stop(),z(...at),r(W)}}function ot(t,e,i,s=0){return new Promise((a=>{let{speed:r}=ht.getInstance(),{targetX:n,targetY:h,opacity:o}=e,c=i/1e3*60,l=void 0===n?0:(n-t.x)/c,d=void 0===h?0:(h-t.y)/c,u=void 0===o?0:(o-t.opacity)/c,p=void 0===e.scale?0:(e.scale-t.scaleX)/c,f=0;!function w(){f<c?(t.x+=l,t.y+=d,t.opacity+=u,f++,t.scaleX+=p,t.scaleY+=p,setTimeout(w,i/c/r)):(t.x=void 0===n?t.x:n,t.y=void 0===h?t.y:h,t.opacity=void 0===o?t.opacity:o,t.scaleX=void 0===e.scale?t.scaleX:e.scale,t.scaleY=void 0===e.scale?t.scaleY:e.scale,setTimeout(a,s/r))}()}))}function ct(t){return new Promise((e=>{let{speed:i}=ht.getInstance();setTimeout(e,t/i)}))}class lt extends d{constructor(t,e,i="u"){super({x:t,y:e}),Object.defineProperty(this,"isPlaying",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.opacity=0,this.type=i}async play(){if(this.isPlaying)return;this.isPlaying=!0;let t=this.y,e=this.x;await ot(this,{scale:2.5,targetX:e-14,targetY:t-6,opacity:1},200),ot(this,{targetY:t+("u"===this.type?-50:50)},600),await ot(this,{opacity:0},700),this.setScale(1),this.x=e,this.y=t,this.opacity=0,this.isPlaying=!1}draw(){M(this.context,"u"===this.type?"11 0 0 11 0 18 11 8 22 18 22 11 11 0":"11 18 22 7 22 0 11 10 0 0 0 7 11 18","u"===this.type?N:b)}}class dt extends d{constructor(t,e){super({x:t,y:e}),Object.defineProperty(this,"started",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"isPlaying",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.opacity=0}async loop(){for(;this.started;){if(this.isPlaying)return;this.isPlaying=!0;let t=this.y;await Promise.all([ot(this,{opacity:1},200),ot(this,{targetY:t+16},400)]),await ot(this,{opacity:0},600),this.y=t,this.isPlaying=!1}}start(){this.started=!0,this.loop()}stop(){this.started=!1}draw(){M(this.context,"4 0 0 12 4 17 8 12 4 0",_)}}class ut extends d{constructor({x:t,y:e,condition:i}){super({x:t,y:e}),Object.defineProperty(this,"head",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"frontHand",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"backHand",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"condition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"isPlayingGameOver",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"upArrow",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"downArrow",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"drop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.condition=i,this.setScale("b"===i?.5:1),this.backHand=new xt(46,60),this.head=new pt(14,2),this.frontHand=new yt(4,58),this.upArrow=new lt(24,30),this.downArrow=new lt(24,30,"d"),this.drop=new dt(16,0),this.addChild([this.backHand,new ft(0,32),new wt(11,101),this.head,this.drop,this.frontHand,this.upArrow,this.downArrow]),a(F,this.onTemplarAttack.bind(this)),a(W,this.onGameOver.bind(this)),a(X,this.onBuffEffect.bind(this)),a($,this.onOverweight.bind(this))}async onOverweight(t){t?this.drop.start():this.drop.stop()}async onBuffEffect(t){(t?this.upArrow:this.downArrow).play()}async onGameOver(){if(this.isPlayingGameOver)return;if(this.isPlayingGameOver=!0,"d"!==this.condition)return;let t=this.head.x,e=this.head.y;await ot(this.head,{targetY:e-12},100),await ct(100),await ot(this.head,{targetY:e+72},250),await ot(this.head,{targetX:t+3,targetY:e+46},100),await ot(this.head,{targetX:t+6,targetY:e+52},200),await ot(this.head,{targetX:t+9,targetY:e+72},300)}async onTemplarAttack(){if("d"===this.condition)return;let{isKnight:t,isDefender:e,isWizard:i}=ht.getInstance();if(t){let t=this.frontHand.x,e=this.frontHand.y;await ot(this.frontHand,{targetX:t+14,targetY:e-5},50),await ct(200),await ot(this.frontHand,{targetX:t,targetY:e},400)}let s=this.backHand.x,a=this.backHand.y;e&&(await ot(this.backHand,{targetX:s+12},50),await ct(200),await ot(this.backHand,{targetX:s},400)),i&&(await ot(this.backHand,{targetX:s+6,targetY:a-10},50),await ct(200),await ot(this.backHand,{targetX:s,targetY:a},400))}render(){ht.getInstance().state===rt.GAME_OVER&&"b"===this.condition||super.render()}}class pt extends d{constructor(t,e){super({x:t,y:e})}draw(){M(this.context,"39 7 31 0 7 0 0 7 0 34 13 40 36 40 39 36 39 7",R),M(this.context,"0 0 12 0 17 0 21 0 21 5 17 5 17 21 12 21 12 5 0 5 0 0",E,18,13)}}class ft extends d{constructor(t,e){super({x:t,y:e}),this.play()}async play(){for(;;)await ot(this,{targetY:this.y+2},1e3),await ot(this,{targetY:this.y-2},1e3)}draw(){M(this.context,"48 40 59 23 46 0 14 3 0 32 12 39 12 69 22 69 23 66 38 58 49 69 60 69 48 40",A,0,1),M(this.context,"39 47 39 12 37 0 31 0 34 12 8 12 8 0 3 0 0 61 45 61 39 47",v,11),S(this.context,12,40,38,7,"#ae5d40"),M(this.context,"11 4 7 4 7 0 4 0 4 4 0 4 0 7 4 7 4 17 7 17 7 7 11 7 11 4",g,33,16)}}class wt extends d{constructor(t,e){super({x:t,y:e})}draw(){M(this.context,"1 12 7 12 11 0 0 0 1 12",g),M(this.context,"0 0 6 6 6 12 13 12 13 0 0 0",g,36)}}class yt extends d{constructor(t,e){super({x:t,y:e})}draw(){let{isKnight:t}=ht.getInstance();t&&M(this.context,"66 1 50 0 0 19 1 23 3 27 54 11 66 1",N,16,-20),M(this.context,"2 2 0 10 13 12 19 7 16 0 10 0 2 2",g)}}class xt extends d{constructor(t,e){super({x:t,y:e})}draw(){let{isDefender:t,isWizard:e}=ht.getInstance();t&&M(this.context,"28 0 0 7 0 42 7 54 28 68 48 54 55 42 55 7 28 0",k,-14,-28),e&&(M(this.context,"3 95 0 94 25 0 32 2 3 95",I,-2,-41),M(this.context,"11 0 2 2 0 10 6 16 14 14 16 6 11 0",C,20,-54)),M(this.context,"6 0 19 0 19 8 12 11 0 11 6 0",g)}}let bt="Trebuchet MS",gt={color:N,font:`13px ${bt}`,anchor:{x:.5,y:.5}},mt=100;class vt extends u{constructor(t,e){super({x:t,y:e,width:462,height:136,color:v});let i=y({text:"Items (equip items add weight until duration ends)",x:10,y:7,color:k,font:`14px ${bt}`});this.addChild([i]),a(L,this.onItemsUpdated.bind(this))}async onItemsUpdated(t,e){t.length>0&&this.addChild(t),e.length>0&&this.removeChild(e);let i=ht.getInstance();await Promise.all(i.currentItems.map((t=>t.setInactive(0)))),await Promise.all(i.currentItems.sort(((t,e)=>t.duration-e.duration)).slice(0,4).map(((t,e)=>t.setActive(60+104*e,76))))}}class Ot extends u{constructor({x:t,y:e,coord:i}){super({x:t,y:e,width:mt,height:mt,color:R,anchor:{x:.5,y:.5}}),Object.defineProperty(this,"coord",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.coord=i}}var Tt,Pt;!function(t){t[t.TEMPLAR=0]="TEMPLAR",t[t.ENEMY=1]="ENEMY",t[t.WEAPON=2]="WEAPON",t[t.SHIELD=3]="SHIELD",t[t.POTION=4]="POTION"}(Tt||(Tt={})),function(t){t[t.PLAYER=0]="PLAYER",t[t.ENEMY=1]="ENEMY"}(Pt||(Pt={}));let It={[nt.KNIGHT]:{[Tt.WEAPON]:3,[Tt.SHIELD]:4},[nt.WIZARD]:{[Tt.WEAPON]:5,[Tt.SHIELD]:6},[nt.DEFENDER]:{[Tt.WEAPON]:5,[Tt.SHIELD]:3}};class kt extends d{constructor(t,e,i=.5){super({x:t,y:e}),this.setScale(i)}draw(){M(this.context,"10 18 23 5 24 0 19 1 6 14 4 13 2 15 4 17 0 22 1 23 2 24 7 20 9 22 11 20 10 18",N)}}var Et,Ct;!function(t){t[t.BACKGROUND=0]="BACKGROUND",t[t.CIRCLE=1]="CIRCLE"}(Et||(Et={}));class _t extends u{constructor({type:t,x:e,y:i}){super({x:e,y:i,width:mt,height:mt,anchor:{x:.5,y:.5}}),Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"main",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"isActive",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mainIcon",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"circle",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.type=t,this.setScale(0),this.main=p({width:mt,height:mt,color:Rt(t,Et.BACKGROUND),anchor:{x:.5,y:.5}}),this.addChild(this.main);let s=t===Tt.TEMPLAR;this.circle=p({radius:s?28:24,color:Rt(t,Et.CIRCLE),anchor:{x:.5,y:.5},y:s?0:this.type===Tt.ENEMY?-14:-20}),this.mainIcon=this.getMainIcon(),this.main.addChild([this.circle,this.mainIcon])}async moveTo(t,e){await ot(this,{targetX:t,targetY:e},100)}async setInactive(t=200){await this.setChildrenOpacity(0,t),this.isActive=!1}async setActive(t,e){this.x=t,this.y=e,await this.setChildrenOpacity(1,200),this.isActive=!0}reset(){this.isActive=!0,this.setChildrenOpacity(1,0),this.setScale(0),this.resetProps()}async setChildrenOpacity(t,e){await Promise.all([ot(this,{opacity:t},e),ot(this.main,{opacity:t},e),...this.children.map((i=>ot(i,{opacity:t},e))),...this.main.children.map((i=>ot(i,{opacity:t},e)))])}update(){this.scaleX<=1&&(this.scaleX+=.1,this.scaleY+=.1,this.scaleX>1&&this.setScale(1))}render(){this.opacity<0||super.render()}}function Rt(t,e){switch(t){case Tt.TEMPLAR:switch(e){case Et.BACKGROUND:return v;case Et.CIRCLE:return m}case Tt.ENEMY:switch(e){case Et.BACKGROUND:return g;case Et.CIRCLE:return b}case Tt.WEAPON:switch(e){case Et.BACKGROUND:return _;case Et.CIRCLE:return C}case Tt.SHIELD:switch(e){case Et.BACKGROUND:return k;case Et.CIRCLE:return I}case Tt.POTION:switch(e){case Et.BACKGROUND:return T;case Et.CIRCLE:return O}}}class At extends d{constructor(t,e){super({x:t,y:e})}draw(){M(this.context,"20 0 13 3 7 0 0 9 13 23 26 9 20 0",E)}}class Dt extends d{constructor(t,e,i,s=k){super({x:t,y:e}),this.setScale(i??1),this.color=s}draw(){M(this.context,"10 0 0 3 0 15 2 19 10 23 17 19 19 15 19 3 10 0",this.color)}}!function(t){t.FRONT="front",t.AROUND="around",t.CROSS="cross"}(Ct||(Ct={}));let Nt={[Ct.FRONT]:2,[Ct.AROUND]:1,[Ct.CROSS]:0};var Mt;function St(t){for(let[e,i]of Object.entries(t)){if("attackDirection"===e)return i!==Ct.FRONT;if("attackType"===e)return i!==Mt.NORMAL;if("number"!=typeof i)throw new Error;return i>0}return!1}!function(t){t.NORMAL="normal",t.PENETRATE="penetrate"}(Mt||(Mt={}));class Bt extends _t{constructor({type:t,x:e,y:i,belongs:s}){super({type:t,x:e,y:i}),Object.defineProperty(this,"damageBg",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attackText",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"healthText",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"shieldText",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"impactText",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"belongs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"health",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"shield",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"attack",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"hitRate",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"critical",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"attackDirection",{enumerable:!0,configurable:!0,writable:!0,value:Ct.FRONT}),Object.defineProperty(this,"hitBack",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"attackType",{enumerable:!0,configurable:!0,writable:!0,value:Mt.NORMAL}),this.belongs=s,this.color=D,this.damageBg=p({x:0,y:0,width:mt,height:mt,anchor:{x:.5,y:.5},color:N,opacity:0}),this.attackText=y({text:`${this.attack}`,x:42,y:39,...gt}),this.healthText=y({text:`${this.health}`,x:-33,y:-34,...gt}),this.shieldText=y({text:`${this.shield}`,x:37,y:-34,...gt}),this.impactText=new jt(0),this.main.addChild([this.damageBg,new kt(20,30),this.attackText,new At(-45.5,-45.5),this.healthText,new Dt(28,-46),this.shieldText,this.impactText])}async execAttack(t,e,i=!1,s=!1){if(e.health<=0||this.health<=0)return;let a=this.x,n=this.y;if(await ot(this.main,{targetX:-5,targetY:-10},100,700),[U.RIGHT,U.LEFT].includes(t)){let e=t===U.RIGHT?-1:1;await ot(this,{targetX:this.x+10*e,targetY:this.y},50),await ot(this,{targetX:this.x-30*e,targetY:this.y},40)}else{let e=t===U.DOWN?-1:1;await ot(this,{targetX:this.x,targetY:this.y+10*e},50),await ot(this,{targetX:this.x,targetY:this.y-30*e},40)}this.type===Tt.TEMPLAR&&r(F),z(...et),await ot(this,{targetX:a,targetY:n},50,400);await Promise.all([ot(this.main,{targetX:0,targetY:0},200),e.applyDamage(this,(()=>{switch(t){case U.RIGHT:return U.LEFT;case U.LEFT:return U.RIGHT;case U.UP:return U.DOWN;case U.DOWN:return U.UP}})(),i,s)])}async playDamage(){for(let t=0;t<2;t++)await ot(this.damageBg,{opacity:.5},80),await ot(this.damageBg,{opacity:0},0);this.damageBg.opacity=0}async applyDamage(t,e,i=!1,s=!1,a=0){let{attack:r,hitBack:n,hitRate:h,critical:o}=t;if(!(Math.random()<=h))return await this.impactText.show("Miss"),void(this.hitBack>0&&!i&&!a&&await this.execAttack(e,t,!0,!1));this.playDamage();let c=Math.random()<=o,l=i?n:a>0?a:r,d=c?2*l:l;c?await this.impactText.show(`Critical -${d}`):await this.impactText.show(`-${d}`);let u=s?d:this.updateShield(-d);!(await this.updateHealth(-u))&&this.hitBack>0&&!i&&!a&&await this.execAttack(e,t,!0,!1)}async applyOverweightDamage(){await Promise.all([this.impactText.show("Overweight -1"),this.updateHealth(-1)])}async updateHealth(t){if(this.health+=t,this.health<=0)return await this.setInactive(),this.deathCallback(),!0;this.healthText.text=`${this.health}`}updateShield(t){let e=0;this.shield+=t,this.shield<=0&&(e=-this.shield,this.shield=0),this.shieldText.text=`${this.shield}`;let{isDefender:i}=ht.getInstance();return this.type===Tt.TEMPLAR&&i&&(this.hitBack=this.shield,r(Y,this)),e}updateAttack(t){this.attack+=t,this.attackText.text=`${this.attack}`}refreshText(){this.attackText.text=`${this.attack}`,this.healthText.text=`${this.health}`,this.shieldText.text=`${this.shield}`,this.impactText.reset()}applyBuff(t,e=!1){if(this.updateHealth(t.health||0),this.updateShield(t.shield||0),this.updateAttack(t.attack||0),this.hitRate+=t.hitRate||0,this.hitRate=Math.max(Math.min(this.hitRate,1),0),this.critical+=t.critical||0,this.critical=Math.max(Math.min(this.critical,1),0),(this.attackDirection!==Ct.CROSS||e)&&(this.attackDirection=t.attackDirection||this.attackDirection),this.attackType=t.attackType||this.attackType,this.hitBack+=t.hitBack||0,this.type===Tt.TEMPLAR&&(r(Y,this),!e)){let e=St(t);r(X,e),e?z(...it(!0)):z(...at)}}}class jt extends u{set text(t){this._text.text=t}constructor(t){super({x:0,y:t,width:100,height:20,color:E,anchor:{x:.5,y:.5},opacity:0}),Object.defineProperty(this,"_text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this._text=y({text:"",font:`16px ${bt}`,color:N,anchor:{x:.5,y:.5}}),this.addChild(this._text)}async show(t){this._text.text=t;let e=this.y;await Promise.all([ot(this._text,{opacity:1},500),ot(this,{opacity:1},500),ot(this,{targetY:this.y-10},500)]),await ct(100),await Promise.all([ot(this._text,{opacity:0},300),ot(this,{opacity:0},300)]),this.y=e}reset(){this.opacity=0,this._text.opacity=0}}function Lt(t){return t[Math.floor(Math.random()*t.length)]}class Ht extends d{constructor(t,e){super({x:t,y:e}),this.setScale(.9)}draw(){M(this.context,"10 0 0 8 0 25 5 32 6 16 2 15 3 12 8 13 8 23 10 25 11 23 11 13 16 12 17 15 13 16 14 32 19 25 19 8 10 0",N)}}let Gt=t=>$t(t,!1),Yt=t=>$t(t,!0),$t=(t,e)=>Object.entries(t).map((([t,i])=>{if(!i)return"";if("attackDirection"===t)return`range: ${i}`;if("attackType"===t)return`${i}`;let s=["hitRate","critical"];return i>0?e?s.includes(t)?`${t} +${(100*i).toFixed()}%`:`${t} +${i}`:`high ${t}`:e?s.includes(t)?`${t} ${(100*i).toFixed()}%`:`${t} ${i}`:`low ${t}`})).join("\n");class Wt extends Bt{constructor({x:t,y:e}){super({type:Tt.ENEMY,x:t,y:e,belongs:Pt.ENEMY}),Object.defineProperty(this,"descriptionText",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.descriptionText=y({x:0,y:18,text:"",...gt,textAlign:"center"}),this.main.addChild(this.descriptionText),this.resetProps()}async onWizardAttack(t,e){let i=ht.getInstance().level;await this.applyDamage(t,U.UP,!1,t.attackType===Mt.PENETRATE,e*i)}getMainIcon(){return new Ht(-8,-29)}deathCallback(){r(H,this)}resetProps(){let{level:t,moveCount:e}=ht.getInstance();this.health=5+2*t,this.attack=2+1*t,this.shield=0,this.hitRate=.8,this.attackDirection=Ct.FRONT,this.attackType=Mt.NORMAL,this.hitBack=0;let i=e>0&&e%13==0||e>=78;i&&(this.circle.color=E),this.critical=i?0:.1;let{buff:s,desc:a}=Lt(Xt(t+1,i));this.applyBuff(s),this.descriptionText.text=a,this.refreshText(),this.damageBg.opacity=0}}let Ft=-1,Xt=(t,e)=>{if(e){let e=[{buff:{attackDirection:Ct.AROUND,health:2*t},desc:'"Whirlstriker"\nRange: around'},{buff:{attackDirection:Ct.CROSS,attack:2*t,health:1*t},desc:'"Spearman"\nRange: cross'},{buff:{hitBack:3*t,health:2*t},desc:'"Counterstriker"\nHit back: '+3*t},{buff:{shield:4*t},desc:'"Guardian"\nShield: '+4*t},{buff:{attackType:Mt.PENETRATE,attack:2*t},desc:'"Penetrator"\nPenetrate shield'},{buff:{attackDirection:Ct.AROUND,attackType:Mt.PENETRATE,shield:5*t},desc:'"Stormpiercer"\nPenetrate, around'}];return Ft<e.length-1?Ft++:Ft=0,[e[Ft]]}return[{shield:2*t,health:-2*t},{health:1*t,attack:Math.floor(-.5*t)},{critical:.05*t,health:-2*t},{attack:1*t,hitRate:-.2}].map((t=>({buff:t,desc:Gt(t)})))};class Ut extends d{constructor(t,e){super({x:t,y:e}),this.setScale(.5)}draw(){M(this.context,"7 7 0 7 0 0 2 0 2 5 7 5 7 7",N,11,6),M(this.context,"22 3 15 0 12 0 12 2 13 2 20 5 22 10 22 14 20 19 13 22 11 22 4 19 2 14 2 10 4 5 11 2 12 2 12 0 9 0 2 3 0 8 0 16 2 21 9 24 15 24 22 21 24 16 24 8 22 3",N)}}class Kt extends d{constructor(t,e){super({x:t,y:e}),this.setScale(.4)}draw(){M(this.context,"24 5 20 5 20 0 12 0 12 5 8 5 0 24 32 24 24 5",N,0,4)}}class zt extends d{constructor(t,e){super({x:t,y:e})}draw(){S(this.context,6,0,6,3,N),M(this.context,"12 6 12 0 6 0 6 6 0 11 4 24 14 24 18 11 12 6",N,0,5)}}class Vt extends d{constructor(t,e){super({x:t,y:e})}draw(){M(this.context,"10 0 0 17 20 17 10 0",v),S(this.context,9,6,2,6,D),S(this.context,9,13,2,2,D)}}let qt={[Tt.WEAPON]:D,[Tt.SHIELD]:E,[Tt.POTION]:P};class Zt extends _t{constructor({type:t,x:e,y:i,duration:s,weight:a}){super({type:t,x:e,y:i}),Object.defineProperty(this,"descriptionText",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"durationText",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"weightText",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"buff",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"duration",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"weight",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"level",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"warningIcon",{enumerable:!0,configurable:!0,writable:!0,value:null}),this.duration=s,this.weight=a,this.buff=this.pickBuff(),this.descriptionText=y({x:0,y:18,text:Yt(this.buff),...gt,textAlign:"center"}),this.durationText=y({text:`${s}`,x:42,y:40,...gt}),this.weightText=y({text:`${a}`,x:-24,y:40,...gt}),this.main.addChild([this.descriptionText,new Ut(22,32),this.durationText,new Kt(-46,32),this.weightText]),this.resetProps()}getMainIcon(){switch(this.type){case Tt.WEAPON:return new kt(-11,-32,1);case Tt.SHIELD:return new Dt(-10,-31,1,N);case Tt.POTION:return new zt(-9,-36);default:throw new Error}}async equip(){this.duration=Math.max(this.duration,2),await Promise.all([ot(this.main,{targetY:-24},300,50),this.setChildrenOpacity(0,300)]),this.main.y=0}resetProps(){if(this.durationText.text=`${this.duration}`,this.weightText.text=`${this.weight}`,this.type===Tt.POTION){this.warningIcon||(this.warningIcon=new Vt(6,-14),this.addChild(this.warningIcon));let t=St(this.buff);this.warningIcon.opacity=t?0:1}4===this.level&&(this.circle.color=qt[this.type])}updateDuration(t){return this.duration+=t,!(this.duration<=0)&&(this.durationText.text=`${this.duration}`,!0)}upgrade(t){this.level+=t.level,this.level=Math.min(this.level,4),this.duration+=t.duration,this.duration=Math.min(this.duration,10),this.weight=Jt(this.type,this.level),this.buff=this.pickBuff();let e=Yt(this.buff);this.descriptionText.text=e,e.split("\n").length>2&&(this.descriptionText.font=`12px ${bt}`,this.descriptionText.y=14),this.resetProps()}pickBuff(){let{isKnight:t,isWizard:e,isDefender:i,level:s}=ht.getInstance(),a=s+1;switch(this.type){case Tt.WEAPON:return Qt(this.level,a,t);case Tt.SHIELD:return te(this.level,a,i);case Tt.POTION:return ee(this.level,a,e);default:throw new Error}}}let Jt=(t,e)=>{if(t===Tt.POTION)return 0;let{cls:i}=ht.getInstance();return It[i][t]+e},Qt=(t,e,i)=>{let s=i?e+2*t:1,a=Math.random();return 1===t?{attack:s}:2===t?a<.6?{attack:s,critical:.05}:{attack:s,hitRate:.05}:3===t?{attack:s,attackDirection:Ct.AROUND,hitBack:1*e}:{attack:s,attackDirection:Ct.CROSS,hitBack:3*e}},te=(t,e,i)=>({shield:Math.floor(e/2+(i?3.7:2)*t)}),ee=(t,e,i)=>{let s=Math.random(),a=Math.ceil(t/3),r=.025+.025*t,n=i?.05:.1;return Lt([{health:e*(s>.65-n*t?a:-a)},{critical:e*s>.95-n*t?r:-r},{hitRate:e*s>.95-n*t?r:-r}])};class ie extends Bt{constructor({x:t,y:e}){super({type:Tt.TEMPLAR,x:t,y:e,belongs:Pt.PLAYER}),Object.defineProperty(this,"weight",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"weightText",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.resetProps(),this.weightText=y({text:`${this.weight}`,x:-24,y:40,...gt}),this.main.addChild([new Kt(-46,32),this.weightText]),a(G,this.updateCls.bind(this))}getMainIcon(){return new ut({x:-18,y:-24,condition:"b"})}deathCallback(){ht.getInstance().gameOver()}updateCls(t){this.cls=t,this.resetProps()}resetProps(){let{isDefender:t,isKnight:e,isWizard:i}=ht.getInstance();this.health=i?6:10,this.shield=t?10:0,this.attack=e?4:1,this.hitRate=i?.65:.8,this.critical=.1,this.attackDirection=Ct.FRONT,this.attackType=Mt.NORMAL,this.hitBack=t?this.shield:0,t&&this.updateWeight(3),this.refreshText(),r(Y,this)}updateWeight(t){this.weight+=t,this.weightText.text=`${this.weight}`;let e=this.weight>=13;this.weightText.color=e?E:N,r($,e)}}class se{static createCard(t,e){let{moveCount:i,isDefender:s,isKnight:a}=ht.getInstance();if(i%13==0)return se.factory({type:Tt.ENEMY,x:t,y:e});{let r=Math.random()>.5?Tt.POTION:Tt.SHIELD,n=[Tt.ENEMY,s?Tt.SHIELD:Tt.WEAPON,r,a?Tt.WEAPON:Tt.POTION,s?Tt.WEAPON:r];return se.factory({type:n[i%n.length],x:t,y:e})}}static factory(t){let{type:e,x:i,y:s}=t,a=ht.getInstance();switch(e){case Tt.TEMPLAR:return new ie({x:i,y:s});case Tt.ENEMY:return new Wt({x:i,y:s});case Tt.WEAPON:return new Zt({...t,duration:4,weight:It[a.cls][Tt.WEAPON]});case Tt.SHIELD:return new Zt({...t,duration:6,weight:It[a.cls][Tt.SHIELD]});case Tt.POTION:return new Zt({...t,duration:5,weight:0})}}}class ae extends u{constructor(t,e){let{width:i,height:s}=h();super({width:i,height:s,opacity:.8,color:D}),Object.defineProperty(this,"wrapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"titleText",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"descText",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.wrapper=p({x:i/2,y:s/2,width:t,height:e,anchor:{x:.5,y:.5},color:m}),this.titleText=y({text:"",x:i/2,y:s/2-52,anchor:{x:.5,y:.5},color:k,font:`24px ${bt}`}),this.descText=y({text:"",x:i/2,y:s/2,anchor:{x:.5,y:.5},color:k,font:`16px ${bt}`,textAlign:"center",lineHeight:1.2}),this.addChild([this.wrapper,this.titleText,this.descText])}}class re extends u{constructor(t,e,i,s=!1){super({x:t,y:e,width:96,height:28,color:k,anchor:{x:.5,y:.5},opacity:s?.3:1}),Object.defineProperty(this,"isDisabled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"canvasCallback",{enumerable:!0,configurable:!0,writable:!0,value:null}),this.isDisabled=s,this.text=y({text:i,anchor:{x:.5,y:.5},color:N,font:`16px ${bt}`}),this.addChild(this.text)}bindClick(t){if(this.isDisabled)return;let e=h();this.canvasCallback=i=>{let{offsetLeft:s,offsetTop:a}=i.target,{world:r}=this,n=r.x-r.width/2,h=r.x+r.width/2,o=r.y-r.height/2,c=r.y+r.height/2,{width:l,height:d}=e,u=Math.min(innerWidth/l,innerHeight/d,devicePixelRatio),p=(i.x-s)/u,f=(i.y-a)/u;p>=n&&p<=h&&f>=o&&f<=c&&t()},e.addEventListener("pointerdown",this.canvasCallback)}offClick(){this.canvasCallback&&h().removeEventListener("pointerdown",this.canvasCallback)}}class ne extends re{constructor(t,e,i){super(t,e,i),this.color=N,this.text.color=A}}let he="tfs.p",oe="tfs.s";class ce extends d{constructor(t,e){super({x:t,y:e})}draw(){M(this.context,"53 9 87 82 35 109 30 76 11 78 10 50 0 47 10 0 53 9",N,0,39),M(this.context,"13 3 54 0 87 22 97 96 87 109 48 95 28 31 0 24 13 3",D,5,14),M(this.context,"0 36 87 56 98 28 79 38 60 29 60 0 44 25 22 22 8 0 5 27 0 36",v,7),M(this.context,"15 0 5 7 0 0 15 0",D,14,62)}}let{canvas:le}=function(t,{contextless:s=!1}={}){return e=document.getElementById(t)||t||document.querySelector("canvas"),s&&(e=e||new Proxy({},n)),i=e.getContext("2d")||new Proxy({},n),i.imageSmoothingEnabled=!1,r("init"),{canvas:e,context:i}}();ht.getInstance(),(onresize=function(){let{width:t,height:e}=le,i=Math.min(innerWidth/t,innerHeight/e,devicePixelRatio);le.style.width=le.width*i+"px",le.style.height=le.height*i+"px"})();let de=new class extends d{constructor(t,e){super({x:t,y:e}),Object.defineProperty(this,"classText",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"infoText",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"overweight",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"overweightText",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let i=p({x:0,y:0,color:m,width:this.context.canvas.width,height:210}),s={text:"",font:`14px ${bt}`,color:k};this.classText=y({x:116,y:12,strokeColor:E,lineWidth:.8,...s}),this.infoText=y({x:116,y:34,...s});let r={anchor:{x:.5,y:.5},opacity:0};this.overweight=p({x:56,y:28,width:100,height:34,color:g,...r}),this.overweightText=y({...s,color:N,text:"Overweight!",...r}),this.overweight.addChild(this.overweightText),this.addChild([i,new ut({x:16,y:74,condition:"i"}),new vt(116,54),this.classText,this.infoText,this.overweight]),a(G,this.updateClassText.bind(this)),a(Y,this.updateTemplarInfo.bind(this)),a($,this.updateOverweightText.bind(this))}updateClassText(t){switch(t){case nt.WIZARD:this.classText.text="Wizard: low attack and hit rate, equip/combine potions to attack all";break;case nt.KNIGHT:this.classText.text="Knight: everything is normal but balanced";break;case nt.DEFENDER:this.classText.text="Defender: low attack, hit back with shield"}}updateTemplarInfo(t){let e=[`Attack: ${t.attackType}, ${t.attackDirection}`,`Hit Rate: ${(100*t.hitRate).toFixed()}%`,`Critical Rate: ${(100*t.critical).toFixed()}%`,`Hit Back: ${t.hitBack}`];this.infoText.text=e.join(" | ")}updateOverweightText(t){this.overweight.opacity=t?1:0,this.overweightText.opacity=t?1:0}}(0,le.height-210),ue=new class extends d{constructor(t,e){super({x:t,y:e}),Object.defineProperty(this,"grids",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"occupiedInfo",{enumerable:!0,configurable:!0,writable:!0,value:Array.from({length:5},(()=>Array.from({length:5},(()=>null))))}),Object.defineProperty(this,"templarCard",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),a(B,this.onSwipe.bind(this));let i=p({x:0,y:0,width:532,height:532,color:A});this.addChild(i);for(let a=0;a<5;a++)for(let t=0;t<5;t++){let e=new Ot({x:8+104*a+50,y:8+104*t+50,coord:[t,a]});this.grids.push(e),this.addChild(e)}let s=this.getGridByCoord([2,2]);this.templarCard=se.factory({type:Tt.TEMPLAR,x:s.x,y:s.y}),this.addChild(this.templarCard),this.occupiedInfo[2][2]=this.templarCard,this.spawnCards(),a(H,this.onRemoveEnemyDead.bind(this))}getGridByCoord(t){let e=this.grids[t[0]+5*t[1]];if(!e)throw new Error;return e}onRemoveEnemyDead(t){for(let e=0;e<5;e++){let i=!1;for(let s=0;s<5;s++){if(this.occupiedInfo[s][e]===t){this.occupiedInfo[s][e]=null,i=!0;break}}if(i)break}this.removeChild(t)}async onSwipe(t){await this.checkOverweight(),await this.moveCards(t),await this.checkAttack(t),await this.checkDuration(),this.spawnCards(),r(j)}async checkOverweight(){this.templarCard.weight<13||this.templarCard.applyOverweightDamage()}async moveCards(t){let e=ht.getInstance(),i=t===U.RIGHT,s=t===U.LEFT,a=t===U.UP,n=t===U.DOWN,h=i?3:1,o=n?3:1,c=i?-1:5,l=n?-1:5,d=i?-1:1,u=n?-1:1,p=[];for(let r=a||n?0:h;r!==c;r+=d)for(let t=s||i?0:o;t!==l;t+=u){let e=this.occupiedInfo[t][r];if(!e)continue;let h=r,o=t;for(;;){let t=h+(i?1:s?-1:0),e=o+(n?1:a?-1:0),r=this.occupiedInfo?.[e]?.[t];if(t<0||t>=5||e<0||e>=5||r)break;h=t,o=e}let c=this.getGridByCoord([o,h]);e.x===c.x&&e.y===c.y||p.push({card:e,x:c.x,y:c.y}),this.occupiedInfo[t][r]=null,this.occupiedInfo[o][h]=e}await Promise.all(p.map((({card:t,x:e,y:i})=>t.moveTo(e,i))));let f=[],w=[];for(let r=a||n?0:h;r!==c;r+=d)for(let t=s||i?0:o;t!==l;t+=u){let h=this.occupiedInfo[t][r];if(!h)continue;let o=r,c=t;for(;;){let t=o+(i?1:s?-1:0),r=c+(n?1:a?-1:0);if(t<0||t>=5||r<0||r>=5)break;let l=this.occupiedInfo?.[r]?.[t];if(l){let i=h.type===Tt.TEMPLAR&&l instanceof Zt,s=h.type===l.type&&h instanceof Zt,a=e.isWizard;if(i||s){i&&h.applyBuff(l.buff),s&&h.upgrade(l),s&&z(...it(!1)),a&&l.type===Tt.POTION&&h.type===Tt.POTION&&w.push(1),await l.equip(),this.occupiedInfo[r][t]=null,h instanceof ie&&l.type!==Tt.POTION?(h.updateWeight(l.weight),f.push(l)):(a&&h.type===Tt.TEMPLAR&&w.push(l.level),await l.setInactive()),this.removeChild(l);let e=this.getGridByCoord([r,t]);await h.moveTo(e.x,e.y);continue}break}o=t,c=r}let l=this.getGridByCoord([c,o]);await h.moveTo(l.x,l.y),this.occupiedInfo[t][r]=null,h instanceof Bt&&h.health<=0||(this.occupiedInfo[c][o]=h)}if(w.length){let t=this.occupiedInfo.flat().filter((t=>t instanceof Wt));for(let e of w)r(F),await Promise.all(t.map((t=>t.onWizardAttack(this.templarCard,e))))}f.length&&e.addItems(f)}spawnCards(){let t=ht.getInstance(),e=t.moveCount%5==1||t.moveCount%5==3;for(let i=0;i<(e?2:1);i++){let t=[];for(let n=0;n<5;n++)for(let e=0;e<5;e++)this.occupiedInfo[e][n]||t.push([e,n]);let e=Math.floor(Math.random()*t.length),[i,s]=t[e],a=this.getGridByCoord([i,s]),r=se.createCard(a.x,a.y);this.addChild(r),this.occupiedInfo[i][s]=r}}async checkAttack(t){let e=[];for(let i=0;i<5;i++)for(let s=0;s<5;s++){let a=this.occupiedInfo[s][i];if(!(a instanceof Bt))continue;let{attackDirection:r}=a,n=r===Ct.FRONT,h=r===Ct.AROUND,o=r===Ct.CROSS;if(n){let r=s+(t===U.UP?-1:t===U.DOWN?1:0),n=i+(t===U.LEFT?-1:t===U.RIGHT?1:0),h=this.occupiedInfo?.[r]?.[n];if(n<0||n>=5||r<0||r>=5||!h||!(h instanceof Bt)||h.belongs===a.belongs)continue;e.push({attacker:a,target:h,direction:t})}else if(h){let t=[[0,1],[1,0],[0,-1],[-1,0]];for(let[r,n]of t){let t=s+r,h=i+n,o=this.occupiedInfo?.[t]?.[h];if(o instanceof Bt&&o.belongs!==a.belongs){let t=0===r&&1===n?U.RIGHT:1===r&&0===n?U.DOWN:0===r&&-1===n?U.LEFT:U.UP;e.push({attacker:a,target:o,direction:t})}}}else o&&[!0,!1].forEach((t=>{let r=t?i:s,n=t?s:i;for(let i=0;i<5;i++){if(i===n)continue;let s=t?this.occupiedInfo[i][r]:this.occupiedInfo[r][i];s instanceof Bt&&s.belongs!==a.belongs&&e.push({attacker:a,target:s,direction:i<n&&t?U.UP:i<n&&!t?U.LEFT:i>n&&t?U.DOWN:U.RIGHT})}}))}for(let{attacker:i,target:s,direction:a}of e)await i.execAttack(a,s,!1,i.attackType===Mt.PENETRATE)}async checkDuration(){let t=ht.getInstance(),e=[];for(let s=0;s<5;s++)for(let t=0;t<5;t++){let i=this.occupiedInfo[t][s];if(i instanceof Zt){i.updateDuration(-1)||(e.push(i),this.occupiedInfo[t][s]=null)}}let i=[];for(let s of t.currentItems){if(!s.updateDuration(-1)){i.push(s),e.push(s);let a={};Object.entries(s.buff).forEach((([e,i])=>{let s="attackDirection",r="attackType";if(e===s){let i=t.currentItems.filter((t=>!!t.buff[s]&&t.duration>0)).sort(((t,e)=>Nt[t.buff[s]]-Nt[e.buff[s]]))[0];a[e]=i?i.buff[s]:Ct.FRONT}else if(e===r){let i=t.currentItems.filter((t=>!!t.buff[r]&&t.duration>0))[0];a[e]=i?i.buff[r]:Mt.NORMAL}else"shield"!==e&&(a[e]=-1*i)})),this.templarCard.applyBuff(a,!0),this.templarCard.updateWeight(-s.weight)}}i.length&&t.removeItems(i),await Promise.all(e.map((t=>t.setInactive())))}}((le.width-532)/2,76),pe=new class extends d{constructor(){super();let{width:t,height:e}=h(),i=y({text:"MOVE 0",x:t/2,y:42,color:A,font:`36px ${bt}`,anchor:{x:.5,y:.5}}),s=p({x:t/2,y:e/2,color:E,width:600,height:100,anchor:{x:.5,y:.5},opacity:0}),r=y({text:"Powerful Enemy Coming!",color:N,font:`36px ${bt}`,anchor:{x:.5,y:.5},opacity:0});s.addChild(r);let n=ht.getInstance(),o=new ne(t-78,60,"Sound: ON");o.bindClick((()=>{n.toggleBGM(),o.text.text="Sound: "+(n.music?"ON":"OFF")}));let c=new ne(78,60,"Speed: 1x");c.bindClick((()=>{n.toggleSpeed(),c.text.text=`Speed: ${n.speed}x`})),this.addChild([i,s,o,c]),a(B,(async()=>{let t=ht.getInstance().moveCount;i.text=`MOVE ${t}`,t%13==0||t>=78&&t%5==0?(this.color=g,r.opacity=1,await ot(s,{opacity:.9},500),await ct(800),await ot(s,{opacity:0},400),r.opacity=0):this.color=A}))}},fe=new class extends ae{constructor(){let{width:t,height:e}=h();super(300,200),Object.defineProperty(this,"restartButton",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"shareButton",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.titleText.text="Game Over",this.titleText.y-=14,this.descText.text="",this.descText.y-=14,this.shareButton=new re(t/2,e/2+36,"Share"),this.restartButton=new re(t/2,e/2+70,"Restart"),this.addChild([this.shareButton,this.restartButton,new ut({x:t/2-32,y:e/2-224,condition:"d"})]),a(W,this.show.bind(this))}show(){let t=ht.getInstance(),e=localStorage.getItem(oe);t.moveCount>parseInt(e??"0")&&(e=`${t.moveCount}`,localStorage.setItem(oe,e));let i=`Survived for ${t.moveCount} moves as a ${t.cls}`;this.descText.text=`${i}!\nBest Score: ${e}`,this.restartButton.bindClick((()=>location.reload())),localStorage.setItem(he,"t"),this.shareButton.bindClick((()=>{let t=`https://x.com/intent/post?text=${encodeURI(`${i} in Templar's Final Stand made by @leokuo0724. Play here:`)}&url=https://leokuo0724.github.io/Templar-s-Final-Stand`;open(t,"_blank")}))}render(){ht.getInstance().state===rt.GAME_OVER&&super.render()}},we=new class extends ae{constructor(){super(360,180),Object.defineProperty(this,"wBtn",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kBtn",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dBtn",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let t="t"===localStorage.getItem(he);this.titleText.text="Pick a Class",this.descText.text=t?"Time to check out new classes!":"Knight is your only option for now";let{width:e,height:i}=h();this.wBtn=new re(e/2-108,i/2+52,nt.WIZARD,!t),this.kBtn=new re(e/2,i/2+52,nt.KNIGHT),this.dBtn=new re(e/2+108,i/2+52,nt.DEFENDER,!t),this.wBtn.bindClick((()=>{this.onButtonClick(nt.WIZARD)})),this.kBtn.bindClick((()=>{this.onButtonClick(nt.KNIGHT)})),this.dBtn.bindClick((()=>{this.onButtonClick(nt.DEFENDER)})),this.addChild([this.wBtn,this.kBtn,this.dBtn])}onButtonClick(t){let e=ht.getInstance();e.state===rt.INIT&&(e.setClass(t),this.wBtn.offClick(),this.kBtn.offClick(),this.dBtn.offClick())}render(){ht.getInstance().state===rt.INIT&&super.render()}},ye=new class extends ae{constructor(){let t=h(),{width:e,height:i}=t;super(e,i),Object.defineProperty(this,"isClicked",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"clickCallback",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),Object.defineProperty(this,"tapCallback",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.wrapper.color=g;let s=new ce(e/2-48,i/2-220);this.addChild([s]),this.initialize()}async initialize(){let t=["It’s 1307.","As a Templar, you’ve just learned King Philip IV isn’t exactly a fan.","Now his army is after you, and survival is your only goal.","Sword ready? Good. Let’s see how long you last.","Tap to start"],e=h();this.clickCallback=this.onClick.bind(this),e.addEventListener("pointerdown",this.clickCallback);for(let i=0;i<t.length;i++){let s=i===t.length-1,a=y({...gt,font:`18px ${bt}`,text:t[i],textAlign:"center",lineHeight:1.5,x:e.width/2,y:e.height/2+i*(s?60:30),opacity:0});this.addChild(a),await ct(this.isClicked?0:200),await ot(a,{opacity:1},this.isClicked&&!s?0:1e3)}this.tapCallback=this.onTapStart.bind(this),e.addEventListener("pointerdown",this.tapCallback)}async onClick(){this.isClicked=!0,h().removeEventListener("pointerdown",this.clickCallback)}async onTapStart(){let t=ht.getInstance();t.state===rt.PROLOGUE&&(t.state=rt.INIT,await Promise.all([ot(this,{opacity:0},500),...this.children.map((t=>ot(t,{opacity:0},500)))]),t.toggleBGM(),h().removeEventListener("pointerdown",this.tapCallback))}render(){let t=ht.getInstance();t.state!==rt.PROLOGUE&&t.state!==rt.INIT||super.render()}},xe=function({fps:e=60,clearCanvas:i=!0,update:s=t,render:n,context:h=o(),blur:c=!1}={}){let l,d,u,p,f,w=0,y=1e3/e,b=1/e,g=i?x:t,m=!0;function v(){if(d=requestAnimationFrame(v),m&&(u=performance.now(),p=u-l,l=u,!(p>1e3))){for(w+=p;w>=y;)r("tick"),f.update(b),w-=y;g(f.context),f.render()}}return c||(window.addEventListener("focus",(()=>{m=!0})),window.addEventListener("blur",(()=>{m=!1}))),a("init",(()=>{f.context??=o()})),f={update:s,render:n,isStopped:!0,context:h,start(){this.isStopped&&(l=performance.now(),this.isStopped=!1,requestAnimationFrame(v))},stop(){this.isStopped=!0,cancelAnimationFrame(d)}},f}({update:()=>{de.update(),ue.update(),pe.update(),fe.update(),ye.update(),we.update()},render:()=>{de.render(),ue.render(),pe.render(),fe.render(),ye.render(),we.render()}});xe.start();
