document.write('<body style=display:flex;align-items:center;justify-content:center;background:#000;touch-action:none;margin:0><canvas height=840 id=c style=background:#ecddba width=600></canvas>');/**
 * @preserve
 * Kontra.js v10.0.0
 */
let t=()=>{};let e,i,s={};function a(t,e){s[t]=s[t]||[],s[t].push(e)}function r(t,...e){(s[t]||[]).map((t=>t(...e)))}let h={get:(e,i)=>"_proxy"==i||t};function n(){return e}function o(){return i}class c{constructor(t=0,e=0,i={}){null!=t.x?(this.x=t.x,this.y=t.y):(this.x=t,this.y=e)}set(t){this.x=t.x,this.y=t.y}add(t){return new c(this.x+t.x,this.y+t.y,this)}}class l{constructor(t){return this.init(t)}init(t={}){this.position=function(){return new c(...arguments)}(),Object.assign(this,t)}update(t){this.advance(t)}advance(t){}_pc(){}}class d extends l{init({width:t=0,height:e=0,context:i=o(),render:s=this.draw,update:r=this.advance,children:h=[],anchor:n={x:0,y:0},opacity:c=1,scaleX:l=1,scaleY:d=1,...u}={}){this._c=[],super.init({width:t,height:e,context:i,anchor:n,opacity:c,scaleX:l,scaleY:d,...u}),this._di=!0,this._uw(),this.addChild(h),this._rf=s,this._uf=r,a("init",(()=>{this.context??=o()}))}update(t){this._uf(t),this.children.map((e=>e.update&&e.update(t)))}render(){let t=this.context;t.save(),(this.x||this.y)&&t.translate(this.x,this.y),1==this.scaleX&&1==this.scaleY||t.scale(this.scaleX,this.scaleY);let e=this.width,i=this.height;this.radius&&(e=i=2*this.radius);let s=-e*this.anchor.x,a=-i*this.anchor.y;(s||a)&&t.translate(s,a),this.context.globalAlpha=this.opacity,this._rf(),(s||a)&&t.translate(-s,-a),this.children.map((t=>t.render&&t.render())),t.restore()}draw(){}_pc(){this._uw(),this.children.map((t=>t._pc()))}get x(){return this.position.x}get y(){return this.position.y}set x(t){this.position.x=t,this._pc()}set y(t){this.position.y=t,this._pc()}get width(){return this._w}set width(t){this._w=t,this._pc()}get height(){return this._h}set height(t){this._h=t,this._pc()}_uw(){if(!this._di)return;let{_wx:t=0,_wy:e=0,_wo:i=1,_wsx:s=1,_wsy:a=1}=this.parent||{};this._wx=this.x,this._wy=this.y,this._ww=this.width,this._wh=this.height,this.radius&&(this._wrx=this.radius,this._wry=this.radius),this._wo=i*this.opacity,this._wsx=s*this.scaleX,this._wsy=a*this.scaleY,this._wx=this._wx*s,this._wy=this._wy*a,this._ww=this.width*this._wsx,this._wh=this.height*this._wsy,this.radius&&(this._wrx=this.radius*this._wsx,this._wry=this.radius*this._wsy),this._wx+=t,this._wy+=e}get world(){return{x:this._wx,y:this._wy,width:this._ww,height:this._wh,radius:this.radius?{x:this._wrx,y:this._wry}:void 0,opacity:this._wo,scaleX:this._wsx,scaleY:this._wsy}}set children(t){this.removeChild(this._c),this.addChild(t)}get children(){return this._c}addChild(...e){e.flat().map((e=>{this.children.push(e),e.parent=this,e._pc=e._pc||t,e._pc()}))}removeChild(...t){t.flat().map((t=>{(function(t,e){let i=t.indexOf(e);if(-1!=i)return t.splice(i,1),!0})(this.children,t)&&(t.parent=null,t._pc())}))}get radius(){return this._r}set radius(t){this._r=t,this._pc()}get opacity(){return this._opa}set opacity(t){this._opa=function(t,e,i){return Math.min(Math.max(t,i),e)}(0,1,t),this._pc()}setScale(t,e=t){this.scaleX=t,this.scaleY=e}get scaleX(){return this._scx}set scaleX(t){this._scx=t,this._pc()}get scaleY(){return this._scy}set scaleY(t){this._scy=t,this._pc()}}class u extends d{init({...t}={}){super.init({...t})}draw(){if(this.color){if(this.context.fillStyle=this.color,this.radius)return this.context.beginPath(),this.context.arc(this.radius,this.radius,this.radius,0,2*Math.PI),void this.context.fill();this.context.fillRect(0,0,this.width,this.height)}}}function p(){return new u(...arguments)}let f=/(\d+)(\w+)/;class w extends d{init({text:t="",textAlign:e="",lineHeight:i=1,font:s=o()?.font,...r}={}){t=""+t,super.init({text:t,textAlign:e,lineHeight:i,font:s,...r}),this.context&&this._p(),a("init",(()=>{this.font??=o().font,this._p()}))}get width(){return this._w}set width(t){this._d=!0,this._w=t,this._fw=t}get text(){return this._t}set text(t){this._d=!0,this._t=""+t}get font(){return this._f}set font(t){this._d=!0,this._f=t,this._fs=function(t){if(!t)return{computed:0};let e=t.match(f),i=+e[1];return{size:i,unit:e[2],computed:i}}(t).computed}get lineHeight(){return this._lh}set lineHeight(t){this._d=!0,this._lh=t}render(){this._d&&this._p(),super.render()}_p(){this._s=[],this._d=!1;let t=this.context,e=[this.text];if(t.font=this.font,e=this.text.split("\n"),!this._s.length&&this.text.includes("\n")){let i=0;e.map((e=>{this._s.push(e),i=Math.max(i,t.measureText(e).width)})),this._w=this._fw||i}this._s.length||(this._s.push(this.text),this._w=this._fw||t.measureText(this.text).width),this.height=this._fs+(this._s.length-1)*this._fs*this.lineHeight,this._uw()}draw(){let t=0,e=this.textAlign,i=this.context;t="right"==e?this.width:"center"==e?this.width/2|0:0,this._s.map(((s,a)=>{i.textBaseline="top",i.textAlign=e,i.fillStyle=this.color,i.font=this.font,i.fillText(s,t,this._fs*this.lineHeight*a)}))}}function b(){return new w(...arguments)}function y(t){let e=t.canvas;t.clearRect(0,0,e.width,e.height)}let g="#AD5F52",x="#913636",m="#E1C584",v="#C89660",k="#B0B17C",P="#6B7F5C",C="#345644",T="#A17D5E",_="#89542F",I="#692F11",O="#64988e",j="#3d7085",B="#B4A18F",S="#796E63",E="#0F2C2E",D="#ECDDBA";function M(t,e,i,s,a){let r=e.split(" ").reduce(((t,e,i,s)=>(i%2==0&&t.push({x:parseFloat(e),y:parseFloat(s[i+1])}),t)),[]);t.beginPath(),t.moveTo(r[0].x+(s??0),r[0].y+(a??0));for(let h=1;h<r.length;h++)t.lineTo(r[h].x+(s??0),r[h].y+(a??0));t.closePath(),t.fillStyle=i,t.fill(),t.closePath()}function A(t,e,i,s,a,r,h,n){t.beginPath(),t.rect(e+0,i+0,s,a),t.fillStyle=r,t.fill(),t.closePath()}function R(t,e,i,s){M(t,"28 0 0 7 0 42 7 54 28 68 48 54 55 42 55 7 28 0",e,i,s)}function $(t,e,i,s){M(t,"66 1 50 0 0 19 1 23 3 27 54 11 66 1",e,i,s)}let Y="s",L="s_f",W="i_u",X="e_d",G="u_t_c",H="u_t_i",F="u_t_w",N="g_o",U="t_a",K="t_b_e",V="g_s";var q;let z;!function(t){t[t.U=0]="U",t[t.D=1]="D",t[t.L=2]="L",t[t.R=3]="R"}(q||(q={}));let J=(...t)=>{let{music:e}=lt.gI();e&&Q(Z(...t))},Q=(...t)=>{z||(z=new AudioContext);let e=z.createBufferSource(),i=z.createBuffer(t.length,t[0].length,et);return t.map(((t,e)=>i.getChannelData(e).set(t))),e.buffer=i,e.connect(z.destination),e.start(),e},Z=(t=1,e=.05,i=220,s=0,a=0,r=.1,h=0,n=1,o=0,c=0,l=0,d=0,u=0,p=0,f=0,w=0,b=0,y=1,g=0,x=0)=>{let m,v,k=2*Math.PI,P=o*=500*k/et**2,C=(0<f?1:-1)*k/4,T=i*=(1+2*e*Math.random()-e)*k/et,_=[],I=0,O=0,j=0,B=1,S=0,E=0,D=0;for(c*=500*k/et**3,f*=k/et,l*=k/et,d*=et,u=et*u|0,v=(s=99+et*s)+(g*=et)+(a*=et)+(r*=et)+(b*=et)|0;j<v;_[j++]=D)++E%(100*w|0)||(D=h?1<h?2<h?3<h?Math.sin((I%k)**3):Math.max(Math.min(Math.tan(I),1),-1):1-(2*I/k%2+2)%2:1-4*Math.abs(Math.round(I/k)-I/k):Math.sin(I),D=(u?1-x+x*Math.sin(2*Math.PI*j/u):1)*(0<D?1:-1)*Math.abs(D)**n*t*tt*(j<s?j/s:j<s+g?1-(j-s)/g*(1-y):j<s+g+a?y:j<v-b?(v-j-b)/r*y:0),D=b?D/2+(b>j?0:(j<v-b?1:(v-j)/b)*_[j-b|0]/2):D),m=(i+=o+=c)*Math.sin(O*f-C),I+=m-m*p*(1-1e9*(Math.sin(j)+1)%2),O+=m-m*p*(1-1e9*(Math.sin(j)**2+1)%2),B&&++B>d&&(i+=l,T+=l,B=0),!u||++S%u||(i=T,o=P,B=B||1);return _},tt=.3,et=44100,it=[[[1.5,0,400],[1.5,0,4e3,,,.03,2,1.25,,,,,.02,6.8,-.3,,.5],[1.5,0,360,,,.12,2,2,,,,,,9,,.1]],[[[2,-1,20,,,,,,,,20,,,,,,,,],[1,1,,,20,,20,,,,,,20,,20,,,,],[,,12,,12,12,15,,15,15,8,,8,8,10,12,13,12]],[[2,-1,20,,,,,,,,20,,,,,,,,],[1,1,,,20,,20,,18,,,,20,,20,,18,,],[,,12,,12,12,15,,15,17,8,,8,8,10,11,13,12]],[[2,-1,20,,,,,,,,20,,,,,,,,],[1,1,,,20,,20,,18,,,,20,,20,,,,],[,,12,,12,12,15,,15,15,20,,,,,,,,],[,,17,,17,17,20,,20,20,25,,,,,,,,]],[[2,-1,20,,,,20,,,,20,,,,20,,,,],[1,1,,,20,,20,,20,,,,20,,20,,20,,],[,,12,,12,12,,25,24,,13,,13,13,,30,29,,],[,,,,,,,22,24,,,,,,,27,25,,]]],[0,1,0,1,3,3,2],66];class st{constructor(t){Object.defineProperty(this,"options",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"startX",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"startY",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"threshold",{enumerable:!0,configurable:!0,writable:!0,value:50}),this.addEventListeners()}addEventListeners(){window.addEventListener("touchstart",this.onStart.bind(this)),window.addEventListener("touchend",this.onEnd.bind(this)),window.addEventListener("touchmove",this.preventDefault.bind(this))}onStart(t){let e=this.getPoint(t);this.startX=e.clientX,this.startY=e.clientY}onEnd(t){let e=this.getPoint(t),i=e.clientX-this.startX,s=e.clientY-this.startY;Math.abs(i)>Math.abs(s)&&Math.abs(i)>this.threshold?i>0?this.options.onSwipeRight?.():this.options.onSwipeLeft?.():Math.abs(s)>this.threshold&&(s>0?this.options.onSwipeDown?.():this.options.onSwipeUp?.())}getPoint(t){return t instanceof TouchEvent?t.changedTouches[0]:t}preventDefault(t){t.preventDefault()}}let at=[3,,179,,.03,.06,,2.8,,,,,,.5,25,,,.46,.05],rt=t=>[.4,,t?100:50,,.3,.4,1,.1,,,t?50:20,,.09,,,,,.5,.2],ht=[3,,576,,,.007,1,.6,,,-273,,,,,,,.64],nt=[,0,350,,.3,.4,,3,,,-65,,.1,,,,,.7];var ot,ct;!function(t){t[t.PROLOGUE=0]="PROLOGUE",t[t.INIT=1]="INIT",t[t.INTRO=2]="INTRO",t[t.IDLE=3]="IDLE",t[t.SWIPING=4]="SWIPING",t[t.GAME_OVER=5]="GAME_OVER"}(ot||(ot={})),function(t){t.K="Knight",t.W="Wizard",t.D="Defender"}(ct||(ct={}));class lt{get level(){return Math.floor(this.move/5)}get isElite(){return this.move>0&&this.move%13==0||this.move>=78&&this.move%5==0}get isW(){return this.cls===ct.W}get isK(){return this.cls===ct.K}get isD(){return this.cls===ct.D}constructor(){Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:ot.PROLOGUE}),Object.defineProperty(this,"move",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"music",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"currentItems",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"cls",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"speed",{enumerable:!0,configurable:!0,writable:!0,value:1}),new st({onSwipeLeft:this.swipe.bind(this,q.L),onSwipeRight:this.swipe.bind(this,q.R),onSwipeUp:this.swipe.bind(this,q.U),onSwipeDown:this.swipe.bind(this,q.D)}),window.addEventListener("keydown",(t=>{["ArrowLeft","a"].includes(t.key)&&this.swipe(q.L),["ArrowRight","d"].includes(t.key)&&this.swipe(q.R),["ArrowUp","w"].includes(t.key)&&this.swipe(q.U),["ArrowDown","s"].includes(t.key)&&this.swipe(q.D)})),a(L,(()=>{this.state!==ot.GAME_OVER&&(this.state=ot.IDLE)}))}static gI(){return lt.instance||(lt.instance=new lt),lt.instance}setClass(t){this.cls=t,r(G,t),this.state=ot.INTRO}toggleBGM(){this.music?(this.music.stop(),this.music=null):(this.music=Q(...((t,e,i,s=125)=>{let a,r,h,n,o,c,l,d,u,p,f,w,b,y,g=0,x=[],m=[],v=[],k=0,P=0,C=1,T={},_=et/s*60>>2;for(;C;k++)x=[C=d=w=0],i.map(((s,I)=>{for(l=e[s][k]||[0,0,0],C|=!!e[s][k],y=w+(e[s][0].length-2-!d)*_,b=I==i.length-1,r=2,n=w;r<l.length+b;d=++r){for(o=l[r],u=r==l.length+b-1&&b||p!=(l[0]||0)|o,h=0;h<_&&d;h++>_-99&&u?f+=(f<1)/99:0)c=(1-f)*x[g++]/2||0,m[n]=(m[n]||0)-c*P+c,v[n]=(v[n++]||0)+c*P+c;o&&(f=o%1,P=l[1]||0,(o|=0)&&(x=T[[p=l[g=0]||0,o]]=T[[p,o]]||(a=[...t[p]],a[2]*=2**((o-12)/12),o>0?Z(...a):[])))}w=y}));return[m,v]})(...it)),this.music.loop=!0)}toggleSpeed(){this.speed=1===this.speed?1.5:1.5===this.speed?2:1}swipe(t){this.state===ot.IDLE&&(this.move++,this.state=ot.SWIPING,J(...ht),r(Y,t))}addItems(t){t.forEach((t=>{this.isD&&(t.duration=Math.min(6,t.duration)),this.currentItems.push(t)})),r(W,t,[])}removeItems(t){let e=this.currentItems.filter((e=>!t.includes(e)));this.currentItems=e,r(W,[],t)}gameOver(){this.state!==ot.GAME_OVER&&(this.state=ot.GAME_OVER,this.music?.stop(),J(...nt),r(N))}}function dt(t,e,i,s=0){return new Promise((a=>{let{speed:r}=lt.gI(),{targetX:h,targetY:n,opacity:o}=e,c=i/1e3*60,l=void 0===h?0:(h-t.x)/c,d=void 0===n?0:(n-t.y)/c,u=void 0===o?0:(o-t.opacity)/c,p=void 0===e.scale?0:(e.scale-t.scaleX)/c,f=0;!function w(){f<c?(t.x+=l,t.y+=d,t.opacity+=u,f++,t.scaleX+=p,t.scaleY+=p,setTimeout(w,i/c/r)):(t.x=void 0===h?t.x:h,t.y=void 0===n?t.y:n,t.opacity=void 0===o?t.opacity:o,t.scaleX=void 0===e.scale?t.scaleX:e.scale,t.scaleY=void 0===e.scale?t.scaleY:e.scale,setTimeout(a,s/r))}()}))}function ut(t){return new Promise((e=>{let{speed:i}=lt.gI();setTimeout(e,t/i)}))}class pt extends d{constructor(t,e,i="u"){super({x:t,y:e}),Object.defineProperty(this,"ing",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.opacity=0,this.type=i}async play(){if(this.ing)return;this.ing=!0;let t=this.y,e=this.x;await dt(this,{scale:2.5,targetX:e-14,targetY:t-6,opacity:1},200),dt(this,{targetY:t+("u"===this.type?-50:50)},600),await dt(this,{opacity:0},700),this.setScale(1),this.x=e,this.y=t,this.opacity=0,this.ing=!1}draw(){M(this.context,"u"===this.type?"11 0 0 11 0 18 11 8 22 18 22 11 11 0":"11 18 22 7 22 0 11 10 0 0 0 7 11 18","u"===this.type?D:g)}}class ft extends d{constructor(t,e){super({x:t,y:e}),Object.defineProperty(this,"started",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ing",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.opacity=0}async loop(){for(;this.started;){if(this.ing)return;this.ing=!0;let t=this.y;await Promise.all([dt(this,{opacity:1},200),dt(this,{targetY:t+16},400)]),await dt(this,{opacity:0},600),this.y=t,this.ing=!1}}start(){this.started=!0,this.loop()}stop(){this.started=!1}draw(){M(this.context,"4 0 0 12 4 17 8 12 4 0",j)}}class wt extends d{constructor({x:t,y:e,condition:i}){super({x:t,y:e}),Object.defineProperty(this,"head",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"frontHand",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"backHand",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"condition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"isOver",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"upArrow",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"downArrow",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"drop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.condition=i,this.setScale("b"===i?.6:1),this.backHand=new mt(46,60),this.head=new bt(14,2),this.frontHand=new xt(4,58),this.upArrow=new pt(24,30),this.downArrow=new pt(24,30,"d"),this.drop=new ft(16,0),this.addChild([this.backHand,new yt(0,32),new gt(11,101),this.head,this.drop,this.frontHand,this.upArrow,this.downArrow]),a(U,this.onTemplarAttack.bind(this)),a(N,this.onGameOver.bind(this)),a(K,this.onBuffEffect.bind(this)),a(F,this.onOverweight.bind(this))}async onOverweight(t){t?this.drop.start():this.drop.stop()}async onBuffEffect(t){(t?this.upArrow:this.downArrow).play()}async onGameOver(){if(this.isOver)return;if(this.isOver=!0,"d"!==this.condition)return;let t=this.head.x,e=this.head.y;await dt(this.head,{targetY:e-12},100),await ut(100),await dt(this.head,{targetY:e+72},250),await dt(this.head,{targetX:t+3,targetY:e+46},100),await dt(this.head,{targetX:t+6,targetY:e+52},200),await dt(this.head,{targetX:t+9,targetY:e+72},300)}async onTemplarAttack(){if("d"===this.condition)return;let{isK:t,isD:e,isW:i}=lt.gI();if(t){let t=this.frontHand.x,e=this.frontHand.y;await dt(this.frontHand,{targetX:t+14,targetY:e-5},50),await ut(200),await dt(this.frontHand,{targetX:t,targetY:e},400)}let s=this.backHand.x,a=this.backHand.y;e&&(await dt(this.backHand,{targetX:s+12},50),await ut(200),await dt(this.backHand,{targetX:s},400)),i&&(await dt(this.backHand,{targetX:s+6,targetY:a-10},50),await ut(200),await dt(this.backHand,{targetX:s,targetY:a},400))}render(){lt.gI().state===ot.GAME_OVER&&"b"===this.condition||super.render()}}class bt extends d{constructor(t,e){super({x:t,y:e})}draw(){M(this.context,"39 7 31 0 7 0 0 7 0 34 13 40 36 40 39 36 39 7",B),M(this.context,"0 0 12 0 17 0 21 0 21 5 17 5 17 21 12 21 12 5 0 5 0 0",I,18,13)}}class yt extends d{constructor(t,e){super({x:t,y:e}),this.play()}async play(){for(;;)await dt(this,{targetY:this.y+2},1e3),await dt(this,{targetY:this.y-2},1e3)}draw(){M(this.context,"48 40 59 23 46 0 14 3 0 32 12 39 12 69 22 69 23 66 38 58 49 69 60 69 48 40",S,0,1),M(this.context,"39 47 39 12 37 0 31 0 34 12 8 12 8 0 3 0 0 61 45 61 39 47",v,11),A(this.context,12,40,38,7,"#ae5d40"),M(this.context,"11 4 7 4 7 0 4 0 4 4 0 4 0 7 4 7 4 17 7 17 7 7 11 7 11 4",x,33,16)}}class gt extends d{constructor(t,e){super({x:t,y:e})}draw(){M(this.context,"1 12 7 12 11 0 0 0 1 12",x),M(this.context,"0 0 6 6 6 12 13 12 13 0 0 0",x,36)}}class xt extends d{constructor(t,e){super({x:t,y:e})}draw(){let{isK:t}=lt.gI();t&&$(this.context,D,16,-20),M(this.context,"2 2 0 10 13 12 19 7 16 0 10 0 2 2",x)}}class mt extends d{constructor(t,e){super({x:t,y:e})}draw(){let{isD:t,isW:e}=lt.gI();t&&R(this.context,_,-14,-28),e&&(M(this.context,"3 95 0 94 25 0 32 2 3 95",T,-2,-41),M(this.context,"11 0 2 2 0 10 6 16 14 14 16 6 11 0",O,20,-54)),M(this.context,"6 0 19 0 19 8 12 11 0 11 6 0",x)}}let vt="Trebuchet MS",kt={color:D,font:`13px ${vt}`,anchor:{x:.5,y:.5}},Pt=100;class Ct extends u{constructor(t,e){super({x:t,y:e,width:462,height:136,color:v});let i=b({text:"Items (equip items add weight until duration ends)",x:10,y:7,color:_,font:`14px ${vt}`});this.addChild([i]),a(W,this.onItemsUpdated.bind(this))}async onItemsUpdated(t,e){t.length>0&&this.addChild(t),e.length>0&&this.removeChild(e);let i=lt.gI();await Promise.all(i.currentItems.map((t=>t.setInactive(0)))),await Promise.all(i.currentItems.sort(((t,e)=>t.duration-e.duration)).slice(0,4).map(((t,e)=>t.setActive(60+104*e,76))))}}class Tt extends u{constructor({x:t,y:e,coord:i}){super({x:t,y:e,width:Pt,height:Pt,color:B,anchor:{x:.5,y:.5}}),Object.defineProperty(this,"coord",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.coord=i}}var _t,It;!function(t){t[t.T=0]="T",t[t.E=1]="E",t[t.W=2]="W",t[t.S=3]="S",t[t.P=4]="P"}(_t||(_t={})),function(t){t[t.PLAYER=0]="PLAYER",t[t.ENEMY=1]="ENEMY"}(It||(It={}));let Ot={[ct.K]:{[_t.W]:3,[_t.S]:4},[ct.W]:{[_t.W]:5,[_t.S]:6},[ct.D]:{[_t.W]:5,[_t.S]:3}};class jt extends d{constructor(t,e,i=.5){super({x:t,y:e}),this.setScale(i)}draw(){M(this.context,"10 18 23 5 24 0 19 1 6 14 4 13 2 15 4 17 0 22 1 23 2 24 7 20 9 22 11 20 10 18",D)}}var Bt,St;!function(t){t[t.B=0]="B",t[t.C=1]="C"}(Bt||(Bt={}));class Et extends u{constructor({type:t,x:e,y:i}){super({x:e,y:i,width:Pt,height:Pt,anchor:{x:.5,y:.5}}),Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"main",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"isActive",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"circle",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.type=t,this.setScale(0),this.main=p({width:Pt,height:Pt,color:Dt(t,Bt.B),anchor:{x:.5,y:.5}}),this.addChild(this.main);let s=t===_t.T;this.circle=p({radius:s?28:24,color:Dt(t,Bt.C),anchor:{x:.5,y:.5},y:s?-4:this.type===_t.E?-14:-20});let a=this.getMainIcon();this.main.addChild([this.circle,a])}async moveTo(t,e){await dt(this,{targetX:t,targetY:e},100)}async setInactive(t=200){await this.setChildrenOpacity(0,t),this.isActive=!1}async setActive(t,e){this.x=t,this.y=e,await this.setChildrenOpacity(1,200),this.isActive=!0}reset(){this.isActive=!0,this.setChildrenOpacity(1,0),this.setScale(0),this.resetProps()}async setChildrenOpacity(t,e){await Promise.all([dt(this,{opacity:t},e),dt(this.main,{opacity:t},e),...this.children.map((i=>dt(i,{opacity:t},e))),...this.main.children.map((i=>dt(i,{opacity:t},e)))])}update(){this.scaleX<=1&&(this.scaleX+=.1,this.scaleY+=.1,this.scaleX>1&&this.setScale(1))}render(){this.opacity<0||super.render()}}function Dt(t,e){switch(t){case _t.T:switch(e){case Bt.B:return v;case Bt.C:return m}case _t.E:switch(e){case Bt.B:return x;case Bt.C:return g}case _t.W:switch(e){case Bt.B:return j;case Bt.C:return O}case _t.S:switch(e){case Bt.B:return _;case Bt.C:return T}case _t.P:switch(e){case Bt.B:return P;case Bt.C:return k}}}class Mt extends d{constructor(t,e){super({x:t,y:e})}draw(){M(this.context,"20 0 13 3 7 0 0 9 13 23 26 9 20 0",I)}}class At extends d{constructor(t,e,i,s=_){super({x:t,y:e}),this.setScale(i??1),this.color=s}draw(){M(this.context,"10 0 0 3 0 15 2 19 10 23 17 19 19 15 19 3 10 0",this.color)}}!function(t){t.F="front",t.A="around",t.C="cross"}(St||(St={}));let Rt={[St.F]:2,[St.A]:1,[St.C]:0};var $t;function Yt(t){for(let[e,i]of Object.entries(t)){if("attackDirection"===e)return i!==St.F;if("attackType"===e)return i!==$t.N;if("number"!=typeof i)throw new Error;return i>0}return!1}!function(t){t.N="normal",t.P="penetrate"}($t||($t={}));class Lt extends Et{constructor({type:t,x:e,y:i,belongs:s}){super({type:t,x:e,y:i}),Object.defineProperty(this,"dmBg",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"aT",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hT",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sT",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"iT",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"belongs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"health",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"shield",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"attack",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"hitRate",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"critical",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"attackDirection",{enumerable:!0,configurable:!0,writable:!0,value:St.F}),Object.defineProperty(this,"hitBack",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"attackType",{enumerable:!0,configurable:!0,writable:!0,value:$t.N}),this.belongs=s,this.color=E,this.dmBg=p({x:0,y:0,width:Pt,height:Pt,anchor:{x:.5,y:.5},color:D,opacity:0}),this.aT=b({text:`${this.attack}`,x:42,y:39,...kt}),this.hT=b({text:`${this.health}`,x:-33,y:-34,...kt}),this.sT=b({text:`${this.shield}`,x:37,y:-34,...kt}),this.iT=new Wt(0),this.main.addChild([this.dmBg,new jt(20,30),this.aT,new Mt(-45.5,-45.5),this.hT,new At(28,-46),this.sT,this.iT])}async execAttack(t,e,i=!1,s=!1){if(e.health<=0||this.health<=0)return;let a=this.x,h=this.y;if(await dt(this.main,{targetX:-5,targetY:-10},100,700),[q.R,q.L].includes(t)){let e=t===q.R?-1:1;await dt(this,{targetX:this.x+10*e,targetY:this.y},50),await dt(this,{targetX:this.x-30*e,targetY:this.y},40)}else{let e=t===q.D?-1:1;await dt(this,{targetX:this.x,targetY:this.y+10*e},50),await dt(this,{targetX:this.x,targetY:this.y-30*e},40)}this.type===_t.T&&r(U),J(...at),await dt(this,{targetX:a,targetY:h},50,400);await Promise.all([dt(this.main,{targetX:0,targetY:0},200),e.applyDamage(this,(()=>{switch(t){case q.R:return q.L;case q.L:return q.R;case q.U:return q.D;case q.D:return q.U}})(),i,s)])}async playDamage(){for(let t=0;t<2;t++)await dt(this.dmBg,{opacity:.5},80),await dt(this.dmBg,{opacity:0},0);this.dmBg.opacity=0}async applyDamage(t,e,i=!1,s=!1,a=0){let{attack:r,hitBack:h,hitRate:n,critical:o}=t;if(!(Math.random()<=n))return await this.iT.show("Miss"),void(this.hitBack>0&&!i&&!a&&await this.execAttack(e,t,!0,!1));this.playDamage();let c=Math.random()<=o,l=i?h:a>0?a:r,d=c?2*l:l;c?await this.iT.show(`Critical -${d}`):await this.iT.show(`-${d}`);let u=s?d:this.updateShield(-d);!(await this.updateHealth(-u))&&this.hitBack>0&&!i&&!a&&await this.execAttack(e,t,!0,!1)}async applyOverweightDamage(){await Promise.all([this.iT.show("Overweight -1"),this.updateHealth(-1)])}async updateHealth(t){if(this.health+=t,this.health<=0)return await this.setInactive(),this.deathCallback(),!0;this.hT.text=`${this.health}`}updateShield(t){let e=0;this.shield+=t,this.shield<=0&&(e=-this.shield,this.shield=0),this.sT.text=`${this.shield}`;let{isD:i}=lt.gI();return this.type===_t.T&&i&&(this.hitBack=this.shield,r(H,this)),e}updateAttack(t){this.attack+=t,this.aT.text=`${this.attack}`}refreshText(){this.aT.text=`${this.attack}`,this.hT.text=`${this.health}`,this.sT.text=`${this.shield}`,this.iT.reset()}applyBuff(t,e=!1){if(this.updateHealth(t.health||0),this.updateShield(t.shield||0),this.updateAttack(t.attack||0),this.hitRate+=t.hitRate||0,this.hitRate=Math.max(Math.min(this.hitRate,1),0),this.critical+=t.critical||0,this.critical=Math.max(Math.min(this.critical,1),0),(this.attackDirection!==St.C||e)&&(this.attackDirection=t.attackDirection||this.attackDirection),this.attackType=t.attackType||this.attackType,this.hitBack+=t.hitBack||0,this.type===_t.T&&(r(H,this),!e)){let e=Yt(t);r(K,e),e?J(...rt(!0)):J(...nt)}}}class Wt extends u{set text(t){this._text.text=t}constructor(t){super({x:0,y:t,width:100,height:20,color:I,anchor:{x:.5,y:.5},opacity:0}),Object.defineProperty(this,"_text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this._text=b({text:"",font:`16px ${vt}`,color:D,anchor:{x:.5,y:.5}}),this.addChild(this._text)}async show(t){this._text.text=t;let e=this.y;await Promise.all([dt(this._text,{opacity:1},500),dt(this,{opacity:1},500),dt(this,{targetY:this.y-10},500)]),await ut(100),await Promise.all([dt(this._text,{opacity:0},300),dt(this,{opacity:0},300)]),this.y=e}reset(){this.opacity=0,this._text.opacity=0}}function Xt(t){return t[Math.floor(Math.random()*t.length)]}let Gt=t=>Ft(t,!1),Ht=t=>Ft(t,!0),Ft=(t,e)=>Object.entries(t).map((([t,i])=>{if(!i)return"";if("attackDirection"===t)return`range: ${i}`;if("attackType"===t)return`${i}`;let s=["hitRate","critical"];return i>0?e?s.includes(t)?`${t} +${(100*i).toFixed()}%`:`${t} +${i}`:`high ${t}`:e?s.includes(t)?`${t} ${(100*i).toFixed()}%`:`${t} ${i}`:`low ${t}`})).join("\n");class Nt extends d{constructor(t,e,i){super({x:t,y:e}),Object.defineProperty(this,"c",{enumerable:!0,configurable:!0,writable:!0,value:null}),this.setScale(.6),this.c=i}draw(){if(M(this.context,"7 0 0 26 13 26 7 0",B,6,48),M(this.context,"24 0 0 10 7 47 24 54 42 47 49 10 24 0",S,14,40),M(this.context,"18 0 0 18 33 9 18 0",B,3,39),M(this.context,"15 0 33 18 0 9 15 0",B,41,39),M(this.context,"7 27 14 30 22 27 29 0 0 0 7 27",E,24,15),M(this.context,"17 0 0 7 0 36 9 47 11 26 5 24 7 19 15 21 15 37 20 37 20 21 28 19 30 24 24 26 25 47 35 36 35 7 17 0",D,21),M(this.context,"11 16 0 10 6 0 16 7 11 16",x,0,66),M(this.context,"6 0 13 26 0 26 6 0",B,58,48),M(this.context,"5 16 16 10 10 0 0 7 5 16",x,61,66),null===this.c)M(this.context,"0 11 20 0 32 0 25 8 1 16 0 11",D,7,61);else{let t=this.c===Kt.W,e=this.c===Kt.S,i=this.c===Kt.L,s=this.c===Kt.G,a=this.c===Kt.CS,r=this.c===Kt.CB;(t||e||i)&&M(this.context,"0 32 2 38 63 6 59 0 0 32",v,8,38),(s||a)&&R(this.context,v,30,38),t&&M(this.context,"0 8 1 30 19 24 31 15 15 0 0 8",E,50,36),a&&(M(this.context,"0 16 16 0 9 21 0 16",E,64,36),M(this.context,"0 0 20 5 0 10 0 0",E,73,64),M(this.context,"8 0 0 8 17 16 8 0",E,65,84)),e&&M(this.context,"0 12 7 4 28 0 13 16 3 17 0 12",E,68,28),i&&M(this.context,"0 34 84 0 9 50 2 44 0 34",E,17,23),r&&($(this.context,v,8,50),M(this.context,"9 11 59 34 62 26 15 1 0 0 9 11",E,8,44))}}}class Ut extends Lt{constructor({x:t,y:e}){super({type:_t.E,x:t,y:e,belongs:It.ENEMY}),Object.defineProperty(this,"dT",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.dT=b({x:0,y:18,text:"",...kt,textAlign:"center"}),this.main.addChild(this.dT),this.resetProps()}async onWizardAttack(t,e){let i=lt.gI().level;await this.applyDamage(t,q.U,!1,t.attackType===$t.P,Math.floor(e*i*.8))}getMainIcon(){return p()}deathCallback(){r(X,this)}resetProps(){let t=lt.gI(),e=t.level;this.health=5+2*e,this.attack=2+1*e,this.shield=0,this.hitRate=.8,this.attackDirection=St.F,this.attackType=$t.N,this.hitBack=0,t.isElite&&(this.circle.color=I),this.critical=t.isElite?0:.1;let{buff:i,desc:s,character:a}=Xt(qt(e+1,t.isElite));this.applyBuff(i),this.dT.text=s,this.refreshText(),this.dmBg.opacity=0;let r=new Nt(-23,-36,a);this.main.children[1]=r}}var Kt;!function(t){t[t.W=0]="W",t[t.G=1]="G",t[t.CS=2]="CS",t[t.S=3]="S",t[t.CB=4]="CB",t[t.L=5]="L"}(Kt||(Kt={}));let Vt=-1,qt=(t,e)=>{if(e){let e=[{buff:{attackDirection:St.A,health:2*t,attack:1*t},desc:'"Whirlstriker"\nRange: around',character:Kt.W},{buff:{shield:4*t},desc:'"Guardian"\nShield: '+4*t,character:Kt.G},{buff:{hitBack:2*t,health:2*t},desc:'"Counterstriker"\nHit back: '+2*t,character:Kt.CS},{buff:{attackType:$t.P,attack:2*t},desc:'"Spearman"\nPenetrate shield',character:Kt.S},{buff:{attackDirection:St.C,health:1*t},desc:'"Crossblade"\nRange: cross',character:Kt.CB},{buff:{attackDirection:St.A,attackType:$t.P,shield:5*t},desc:'"Lancepiercer"\nPenetrate, around',character:Kt.L}];return Vt<e.length-1?Vt++:Vt=0,[e[Vt]]}return[{shield:2*t,health:-2*t},{health:1*t,attack:Math.floor(-.5*t)},{critical:.05*t,health:-2*t},{attack:1*t,hitRate:-.2}].map((t=>({buff:t,desc:Gt(t),character:null})))};class zt extends d{constructor(t,e){super({x:t,y:e}),this.setScale(.5)}draw(){M(this.context,"7 7 0 7 0 0 2 0 2 5 7 5 7 7",D,11,6),M(this.context,"22 3 15 0 12 0 12 2 13 2 20 5 22 10 22 14 20 19 13 22 11 22 4 19 2 14 2 10 4 5 11 2 12 2 12 0 9 0 2 3 0 8 0 16 2 21 9 24 15 24 22 21 24 16 24 8 22 3",D)}}class Jt extends d{constructor(t,e){super({x:t,y:e}),this.setScale(.4)}draw(){M(this.context,"24 5 20 5 20 0 12 0 12 5 8 5 0 24 32 24 24 5",D,0,4)}}class Qt extends d{constructor(t,e){super({x:t,y:e})}draw(){A(this.context,6,0,6,3,D),M(this.context,"12 6 12 0 6 0 6 6 0 11 4 24 14 24 18 11 12 6",D,0,5)}}class Zt extends d{constructor(t,e){super({x:t,y:e})}draw(){M(this.context,"10 0 0 17 20 17 10 0",v),A(this.context,9,6,2,6,E),A(this.context,9,13,2,2,E)}}let te={[_t.W]:E,[_t.S]:I,[_t.P]:C};class ee extends Et{constructor({type:t,x:e,y:i,duration:s,weight:a}){super({type:t,x:e,y:i}),Object.defineProperty(this,"dT",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"drT",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"wT",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"buff",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"duration",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"weight",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"level",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"wIcon",{enumerable:!0,configurable:!0,writable:!0,value:null}),this.duration=s,this.weight=a,this.buff=this.pickBuff(),this.dT=b({x:0,y:18,text:Ht(this.buff),...kt,textAlign:"center"}),this.drT=b({text:`${s}`,x:42,y:40,...kt}),this.wT=b({text:`${a}`,x:-24,y:40,...kt}),this.main.addChild([this.dT,new zt(22,32),this.drT,new Jt(-46,32),this.wT]),this.resetProps()}getMainIcon(){switch(this.type){case _t.W:return new jt(-11,-32,1);case _t.S:return new At(-10,-31,1,D);case _t.P:return new Qt(-9,-36);default:throw new Error}}async equip(){this.duration=Math.max(this.duration,2),await Promise.all([dt(this.main,{targetY:-24},300,50),this.setChildrenOpacity(0,300)]),this.main.y=0}resetProps(){if(this.drT.text=`${this.duration}`,this.wT.text=`${this.weight}`,this.type===_t.P){this.wIcon||(this.wIcon=new Zt(6,-14),this.addChild(this.wIcon));let t=Yt(this.buff);this.wIcon.opacity=t?0:1}4===this.level&&(this.circle.color=te[this.type])}updateDuration(t){return this.duration+=t,!(this.duration<=0)&&(this.drT.text=`${this.duration}`,!0)}upgrade(t){this.level+=t.level,this.level=Math.min(this.level,4),this.duration+=t.duration,this.duration=Math.min(this.duration,10),this.weight=ie(this.type,this.level),this.buff=this.pickBuff();let e=Ht(this.buff);this.dT.text=e,e.split("\n").length>2&&(this.dT.font=`12px ${vt}`,this.dT.y=14),this.resetProps()}pickBuff(){let{isK:t,isW:e,isD:i,level:s}=lt.gI(),a=s+1;switch(this.type){case _t.W:return se(this.level,a,t);case _t.S:return ae(this.level,a,i);case _t.P:return re(this.level,a,e);default:throw new Error}}}let ie=(t,e)=>{if(t===_t.P)return 0;let{cls:i}=lt.gI();return Ot[i][t]+e},se=(t,e,i)=>{let s=i?e+2*t:1,a=Math.random();return 1===t?{attack:s}:2===t?a<.6?{attack:s,critical:.05}:{attack:s,hitRate:.05}:3===t?{attack:s,attackDirection:St.A,hitBack:1*e}:{attack:s,attackDirection:St.C,hitBack:3*e}},ae=(t,e,i)=>({shield:Math.floor(e/2+(i?3.7:2)*t)}),re=(t,e,i)=>{let s=Math.random(),a=Math.ceil(t/3),r=.025+.025*t,h=i?.05:.1;return Xt([{health:e*(s>.65-h*t?a:-a)},{critical:e*s>.95-h*t?r:-r},{hitRate:e*s>.95-h*t?r:-r}])};class he extends Lt{constructor({x:t,y:e}){super({type:_t.T,x:t,y:e,belongs:It.PLAYER}),Object.defineProperty(this,"weight",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"wT",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.resetProps(),this.wT=b({text:`${this.weight}`,x:-24,y:40,...kt}),this.main.addChild([new Jt(-46,32),this.wT]),a(G,this.updateCls.bind(this))}getMainIcon(){return new wt({x:-21,y:-30,condition:"b"})}deathCallback(){lt.gI().gameOver()}updateCls(t){this.cls=t,this.resetProps()}resetProps(){let{isD:t,isK:e,isW:i}=lt.gI();this.health=i?6:10,this.shield=t?10:0,this.attack=e?4:1,this.hitRate=i?.65:.8,this.critical=.1,this.attackDirection=St.F,this.attackType=$t.N,this.hitBack=t?this.shield:0,t&&this.updateWeight(3),this.refreshText(),r(H,this)}updateWeight(t){this.weight+=t,this.wT.text=`${this.weight}`;let e=this.weight>=13;this.wT.color=e?I:D,r(F,e)}}class ne{static createCard(t,e){let{move:i,isD:s,isK:a}=lt.gI();if(i%13==0)return ne.factory({type:_t.E,x:t,y:e});{let r=Math.random()>.5?_t.P:_t.S,h=[_t.E,s?_t.S:_t.W,r,a?_t.W:_t.P,s?_t.W:r];return ne.factory({type:h[i%h.length],x:t,y:e})}}static factory(t){let{type:e,x:i,y:s}=t,a=lt.gI();switch(e){case _t.T:return new he({x:i,y:s});case _t.E:return new Ut({x:i,y:s});case _t.W:return new ee({...t,duration:4,weight:Ot[a.cls][_t.W]});case _t.S:return new ee({...t,duration:6,weight:Ot[a.cls][_t.S]});case _t.P:return new ee({...t,duration:5,weight:0})}}}let oe=532;class ce extends u{constructor(t,e){let{width:i,height:s}=n();super({width:i,height:s,opacity:.8,color:E}),Object.defineProperty(this,"wrapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tT",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dT",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.wrapper=p({x:i/2,y:s/2,width:t,height:e,anchor:{x:.5,y:.5},color:m}),this.tT=b({text:"",x:i/2,y:s/2-52,anchor:{x:.5,y:.5},color:_,font:`24px ${vt}`}),this.dT=b({text:"",x:i/2,y:s/2,anchor:{x:.5,y:.5},color:_,font:`16px ${vt}`,textAlign:"center",lineHeight:1.2}),this.addChild([this.wrapper,this.tT,this.dT])}}class le extends u{constructor(t,e,i,s=!1){super({x:t,y:e,width:96,height:28,color:_,anchor:{x:.5,y:.5},opacity:s?.3:1}),Object.defineProperty(this,"isDisabled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"canvasCallback",{enumerable:!0,configurable:!0,writable:!0,value:null}),this.isDisabled=s,this.text=b({text:i,anchor:{x:.5,y:.5},color:D,font:`16px ${vt}`}),this.addChild(this.text)}bindClick(t){if(this.isDisabled)return;let e=n();this.canvasCallback=e=>{de(e,this)&&t()},e.addEventListener("pointerdown",this.canvasCallback)}offClick(){this.canvasCallback&&n().removeEventListener("pointerdown",this.canvasCallback)}}function de(t,e){let{offsetLeft:i,offsetTop:s}=t.target,{world:a}=e,r=a.x-a.width/2,h=a.x+a.width/2,o=a.y-a.height/2,c=a.y+a.height/2,{width:l,height:d}=n(),u=Math.min(innerWidth/l,innerHeight/d,devicePixelRatio),p=(t.x-i)/u,f=(t.y-s)/u;return p>=r&&p<=h&&f>=o&&f<=c}class ue extends le{constructor(t,e,i){super(t,e,i),this.color=D,this.text.color=S}}let pe="tfs.p",fe="tfs.s";class we extends d{constructor(t,e){super({x:t,y:e})}draw(){M(this.context,"53 9 87 82 35 109 30 76 11 78 10 50 0 47 10 0 53 9",D,0,39),M(this.context,"13 3 54 0 87 22 97 96 87 109 48 95 28 31 0 24 13 3",E,5,14),M(this.context,"0 36 87 56 98 28 79 38 60 29 60 0 44 25 22 22 8 0 5 27 0 36",v,7),M(this.context,"15 0 5 7 0 0 15 0",E,14,62)}}class be extends d{constructor(t,e){super({x:t,y:e}),this.play()}async play(){for(;;)await dt(this,{targetY:this.y-5},800),await dt(this,{targetY:this.y+5},800)}draw(){M(this.context,"6.3 11 12.6 0 0 0 6.3 11",D)}}let{canvas:ye}=function(t,{contextless:s=!1}={}){return e=document.getElementById(t)||t||document.querySelector("canvas"),s&&(e=e||new Proxy({},h)),i=e.getContext("2d")||new Proxy({},h),i.imageSmoothingEnabled=!1,r("init"),{canvas:e,context:i}}();lt.gI(),(onresize=function(){let{width:t,height:e}=ye,i=Math.min(innerWidth/t,innerHeight/e,devicePixelRatio);ye.style.width=ye.width*i+"px",ye.style.height=ye.height*i+"px"})();let ge=new class extends d{constructor(t,e){super({x:t,y:e}),Object.defineProperty(this,"cT",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"iT",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ow",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"owT",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let i=p({x:0,y:0,color:m,width:this.context.canvas.width,height:210}),s={text:"",font:`14px ${vt}`,color:_};this.cT=b({x:116,y:12,strokeColor:I,lineWidth:.8,...s}),this.iT=b({x:116,y:34,...s});let r={anchor:{x:.5,y:.5},opacity:0};this.ow=p({x:56,y:28,width:100,height:34,color:x,...r}),this.owT=b({...s,color:D,text:"Overweight!",...r}),this.ow.addChild(this.owT),this.addChild([i,new wt({x:16,y:74,condition:"i"}),new Ct(116,54),this.cT,this.iT,this.ow]),a(G,this.updateClassText.bind(this)),a(H,this.updateTemplarInfo.bind(this)),a(F,this.updateOverweightText.bind(this))}updateClassText(t){switch(t){case ct.W:this.cT.text="Wizard: low attack and hit rate, equip/combine potions to attack all";break;case ct.K:this.cT.text="Knight: everything is normal but balanced";break;case ct.D:this.cT.text="Defender: low attack, hit back with shield"}}updateTemplarInfo(t){let e=[`Attack: ${t.attackType}, ${t.attackDirection}`,`Hit Rate: ${(100*t.hitRate).toFixed()}%`,`Critical Rate: ${(100*t.critical).toFixed()}%`,`Hit Back: ${t.hitBack}`];this.iT.text=e.join(" | ")}updateOverweightText(t){this.ow.opacity=t?1:0,this.owT.opacity=t?1:0}}(0,ye.height-210),xe=new class extends d{constructor(t,e){super({x:t,y:e,anchor:{x:.5,y:.5}}),Object.defineProperty(this,"grids",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"occuInfo",{enumerable:!0,configurable:!0,writable:!0,value:Array.from({length:5},(()=>Array.from({length:5},(()=>null))))}),Object.defineProperty(this,"templarCard",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),a(Y,this.onSwipe.bind(this));let i=p({x:-266,y:-266,width:oe,height:oe,color:S});this.addChild(i);for(let a=0;a<5;a++)for(let t=0;t<5;t++){let e=new Tt({x:8+104*a+50-266,y:8+104*t+50-266,coord:[t,a]});this.grids.push(e),this.addChild(e)}let s=this.getGridByCoord([2,2]);this.templarCard=ne.factory({type:_t.T,x:s.x,y:s.y}),this.addChild(this.templarCard),this.occuInfo[2][2]=this.templarCard,this.spawnCards(),a(X,this.onRemoveEnemyDead.bind(this)),a(G,this.onClsUpdated.bind(this)),a(V,this.onGameStart.bind(this))}async onClsUpdated(){await dt(this,{scale:4},200)}async onGameStart(){await dt(this,{scale:1},200)}getGridByCoord(t){let e=this.grids[t[0]+5*t[1]];if(!e)throw new Error;return e}onRemoveEnemyDead(t){for(let e=0;e<5;e++){let i=!1;for(let s=0;s<5;s++){if(this.occuInfo[s][e]===t){this.occuInfo[s][e]=null,i=!0;break}}if(i)break}this.removeChild(t)}async onSwipe(t){await this.checkOverweight(),await this.moveCards(t),await this.checkAttack(t),await this.checkDuration(),this.spawnCards(),r(L)}async checkOverweight(){this.templarCard.weight<13||this.templarCard.applyOverweightDamage()}async moveCards(t){let e=lt.gI(),i=t===q.R,s=t===q.L,a=t===q.U,h=t===q.D,n=i?3:1,o=h?3:1,c=i?-1:5,l=h?-1:5,d=i?-1:1,u=h?-1:1,p=[];for(let r=a||h?0:n;r!==c;r+=d)for(let t=s||i?0:o;t!==l;t+=u){let e=this.occuInfo[t][r];if(!e)continue;let n=r,o=t;for(;;){let t=n+(i?1:s?-1:0),e=o+(h?1:a?-1:0),r=this.occuInfo?.[e]?.[t];if(t<0||t>=5||e<0||e>=5||r)break;n=t,o=e}let c=this.getGridByCoord([o,n]);e.x===c.x&&e.y===c.y||p.push({card:e,x:c.x,y:c.y}),this.occuInfo[t][r]=null,this.occuInfo[o][n]=e}await Promise.all(p.map((({card:t,x:e,y:i})=>t.moveTo(e,i))));let f=[],w=[];for(let r=a||h?0:n;r!==c;r+=d)for(let t=s||i?0:o;t!==l;t+=u){let n=this.occuInfo[t][r];if(!n)continue;let o=r,c=t;for(;;){let t=o+(i?1:s?-1:0),r=c+(h?1:a?-1:0);if(t<0||t>=5||r<0||r>=5)break;let l=this.occuInfo?.[r]?.[t];if(l){let i=n.type===_t.T&&l instanceof ee,s=n.type===l.type&&n instanceof ee,a=e.isW;if(i||s){i&&n.applyBuff(l.buff),s&&n.upgrade(l),s&&J(...rt(!1)),a&&l.type===_t.P&&n.type===_t.P&&w.push(1),await l.equip(),this.occuInfo[r][t]=null,n instanceof he&&l.type!==_t.P?(n.updateWeight(l.weight),f.push(l)):(a&&n.type===_t.T&&w.push(l.level),await l.setInactive()),this.removeChild(l);let e=this.getGridByCoord([r,t]);n.x===e.x&&n.y===e.y||await n.moveTo(e.x,e.y);continue}break}o=t,c=r}let l=this.getGridByCoord([c,o]);n.x===l.x&&n.y===l.y||await n.moveTo(l.x,l.y),this.occuInfo[t][r]=null,n instanceof Lt&&n.health<=0||(this.occuInfo[c][o]=n)}if(w.length){let t=this.occuInfo.flat().filter((t=>t instanceof Ut));for(let e of w)r(U),await Promise.all(t.map((t=>t.onWizardAttack(this.templarCard,e))))}f.length&&e.addItems(f)}spawnCards(){let t=lt.gI(),e=t.move%5==1||t.move%5==3;for(let i=0;i<(e?2:1);i++){let t=[];for(let h=0;h<5;h++)for(let e=0;e<5;e++)this.occuInfo[e][h]||t.push([e,h]);let e=Math.floor(Math.random()*t.length),[i,s]=t[e],a=this.getGridByCoord([i,s]),r=ne.createCard(a.x,a.y);this.addChild(r),this.occuInfo[i][s]=r}}async checkAttack(t){let e=[];for(let i=0;i<5;i++)for(let s=0;s<5;s++){let a=this.occuInfo[s][i];if(!(a instanceof Lt))continue;let{attackDirection:r}=a,h=r===St.F,n=r===St.A,o=r===St.C;if(h){let r=s+(t===q.U?-1:t===q.D?1:0),h=i+(t===q.L?-1:t===q.R?1:0),n=this.occuInfo?.[r]?.[h];if(h<0||h>=5||r<0||r>=5||!n||!(n instanceof Lt)||n.belongs===a.belongs)continue;e.push({attacker:a,target:n,direction:t})}else if(n){let t=[[0,1],[1,0],[0,-1],[-1,0]];for(let[r,h]of t){let t=s+r,n=i+h,o=this.occuInfo?.[t]?.[n];if(o instanceof Lt&&o.belongs!==a.belongs){let t=0===r&&1===h?q.R:1===r&&0===h?q.D:0===r&&-1===h?q.L:q.U;e.push({attacker:a,target:o,direction:t})}}}else o&&[!0,!1].forEach((t=>{let r=t?i:s,h=t?s:i;for(let i=0;i<5;i++){if(i===h)continue;let s=t?this.occuInfo[i][r]:this.occuInfo[r][i];s instanceof Lt&&s.belongs!==a.belongs&&e.push({attacker:a,target:s,direction:i<h&&t?q.U:i<h&&!t?q.L:i>h&&t?q.D:q.R})}}))}for(let{attacker:i,target:s,direction:a}of e)await i.execAttack(a,s,!1,i.attackType===$t.P)}async checkDuration(){let t=lt.gI(),e=[];for(let s=0;s<5;s++)for(let t=0;t<5;t++){let i=this.occuInfo[t][s];if(i instanceof ee){i.updateDuration(-1)||(e.push(i),this.occuInfo[t][s]=null)}}let i=[];for(let s of t.currentItems){if(!s.updateDuration(-1)){i.push(s),e.push(s);let a={};Object.entries(s.buff).forEach((([e,i])=>{let s="attackDirection",r="attackType";if(e===s){let i=t.currentItems.filter((t=>!!t.buff[s]&&t.duration>0)).sort(((t,e)=>Rt[t.buff[s]]-Rt[e.buff[s]]))[0];a[e]=i?i.buff[s]:St.F}else if(e===r){let i=t.currentItems.filter((t=>!!t.buff[r]&&t.duration>0))[0];a[e]=i?i.buff[r]:$t.N}else"shield"!==e&&(a[e]=-1*i)})),this.templarCard.applyBuff(a,!0),this.templarCard.updateWeight(-s.weight)}}i.length&&t.removeItems(i),await Promise.all(e.map((t=>t.setInactive())))}}(ye.width/2,340),me=new class extends d{constructor(){super();let{width:t,height:e}=n(),i=b({text:"MOVE 0",x:t/2,y:42,color:S,font:`36px ${vt}`,anchor:{x:.5,y:.5}}),s=p({x:t/2,y:e/2,color:I,width:600,height:100,anchor:{x:.5,y:.5},opacity:0}),r=b({text:"Powerful Enemy Coming!",color:D,font:`36px ${vt}`,anchor:{x:.5,y:.5},opacity:0});s.addChild(r);let h=lt.gI(),o=new ue(t-78,60,"Sound: ON");o.bindClick((()=>{h.toggleBGM(),o.text.text="Sound: "+(h.music?"ON":"OFF")}));let c=new ue(78,60,"Speed: 1x");c.bindClick((()=>{h.toggleSpeed(),c.text.text=`Speed: ${h.speed}x`})),this.addChild([i,s,o,c]),a(Y,(async()=>{let t=lt.gI(),e=t.move;i.text=`MOVE ${e}`,t.isElite?(this.color=x,r.opacity=1,await dt(s,{opacity:.9},500),await ut(800),await dt(s,{opacity:0},400),r.opacity=0):this.color=S}))}},ve=new class extends ce{constructor(){let{width:t,height:e}=n();super(300,200),Object.defineProperty(this,"rBtn",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sBtn",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"isShown",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.tT.text="Game Over",this.tT.y-=14,this.dT.text="",this.dT.y-=14,this.sBtn=new le(t/2,e/2+36,"Share"),this.rBtn=new le(t/2,e/2+70,"Restart"),this.addChild([this.sBtn,this.rBtn,new wt({x:t/2-32,y:e/2-224,condition:"d"})]),a(N,this.show.bind(this))}show(){if(this.isShown)return;this.isShown=!0;let t=lt.gI(),e=localStorage.getItem(fe);t.move>parseInt(e??"0")&&(e=`${t.move}`,localStorage.setItem(fe,e));let i=`Survived for ${t.move} moves as a ${t.cls}`;this.dT.text=`${i}!\nBest Score: ${e}`,this.rBtn.bindClick((()=>location.reload())),localStorage.setItem(pe,"t"),this.sBtn.bindClick((()=>{let t=`https://x.com/intent/post?text=${encodeURI(`${i} in Templar's Final Stand made by @leokuo0724. Play here:`)}&url=https://leokuo0724.github.io/Templar-s-Final-Stand`;open(t,"_blank")}))}render(){lt.gI().state===ot.GAME_OVER&&super.render()}},ke=new class extends ce{constructor(){super(360,180),Object.defineProperty(this,"wBtn",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kBtn",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dBtn",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let t="t"===localStorage.getItem(pe);this.tT.text="Pick a Class",this.dT.text=t?"Time to check out new classes!":"Knight is your only option for now";let{width:e,height:i}=n();this.wBtn=new le(e/2-108,i/2+52,ct.W,!t),this.kBtn=new le(e/2,i/2+52,ct.K),this.dBtn=new le(e/2+108,i/2+52,ct.D,!t),this.wBtn.bindClick((()=>{this.onButtonClick(ct.W)})),this.kBtn.bindClick((()=>{this.onButtonClick(ct.K)})),this.dBtn.bindClick((()=>{this.onButtonClick(ct.D)})),this.addChild([this.wBtn,this.kBtn,this.dBtn])}onButtonClick(t){let e=lt.gI();e.state===ot.INIT&&(e.setClass(t),this.wBtn.offClick(),this.kBtn.offClick(),this.dBtn.offClick())}render(){lt.gI().state===ot.INIT&&super.render()}},Pe=new class extends ce{constructor(){let t=n(),{width:e,height:i}=t;super(e,i),Object.defineProperty(this,"isClicked",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"clickCallback",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),Object.defineProperty(this,"tapCallback",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.wrapper.color=x;let s=new we(e/2-48,i/2-220);this.addChild([s]),this.initialize()}async initialize(){let t=["It’s October 13, 1307.","As a Templar, you’ve just learned King Philip IV isn’t a fan.","Now his army is after you, and survival is your only goal.","Sword ready? Good. Let’s see how long you last.","Tap to start"],e=n();this.clickCallback=this.onClick.bind(this),e.addEventListener("pointerdown",this.clickCallback);for(let i=0;i<t.length;i++){let s=i===t.length-1,a=b({...kt,font:`18px ${vt}`,text:t[i],textAlign:"center",lineHeight:1.5,x:e.width/2,y:e.height/2+i*(s?60:30),opacity:0});this.addChild(a),await ut(this.isClicked?0:200),await dt(a,{opacity:1},this.isClicked&&!s?0:1e3)}this.tapCallback=this.onTapStart.bind(this),e.addEventListener("pointerdown",this.tapCallback)}async onClick(){this.isClicked=!0,n().removeEventListener("pointerdown",this.clickCallback)}async onTapStart(){let t=lt.gI();t.state===ot.PROLOGUE&&(t.state=ot.INIT,await Promise.all([dt(this,{opacity:0},500),...this.children.map((t=>dt(t,{opacity:0},500)))]),t.toggleBGM(),n().removeEventListener("pointerdown",this.tapCallback))}render(){let t=lt.gI();t.state!==ot.PROLOGUE&&t.state!==ot.INIT||super.render()}},Ce=new class extends u{constructor(t,e){super({x:t,y:e,width:500,height:200,color:E,anchor:{x:.5,y:.5}}),Object.defineProperty(this,"currI",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"clickCallback",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"paragraphs",{enumerable:!0,configurable:!0,writable:!0,value:["Move up, down, left, or right.\nI can move toward enemies or items\nto attack or equip.","Same items combine into something stronger\n—except potions.\nMight become buff or debuff.","Everything but potions adds weight,\nand if it hits 13,\nmy triskaidekaphobia makes every step hurt\n until the item's duration ends."]}),this.content=b({text:this.paragraphs[this.currI],...kt,font:`18px ${vt}`,textAlign:"center",lineHeight:1.5}),this.addChild([this.content,new be(224,76)]);let i=n();this.clickCallback=this.onClick.bind(this),i.addEventListener("pointerdown",this.clickCallback),a(G,this.onCls.bind(this))}onCls(t){let e={[ct.K]:"I'm nothing fancy\n—just balanced and ready to fight!",[ct.W]:"I'm weak\nbut can attack all foes with potions!",[ct.D]:"I get hit\nand hit back harder!"};this.paragraphs.push(`As a ${t}\n`+e[t])}onClick(t){let e=lt.gI();if(e.state!==ot.INTRO)return;let i=n();de(t,this)&&(this.currI===this.paragraphs.length-1?this.clickCallback&&(i.removeEventListener("pointerdown",this.clickCallback),e.state=ot.IDLE,r(V)):(this.currI++,this.content.text=this.paragraphs[this.currI]))}render(){lt.gI().state===ot.INTRO&&super.render()}}(ye.width/2,ye.height-150),Te=function({fps:e=60,clearCanvas:i=!0,update:s=t,render:h,context:n=o(),blur:c=!1}={}){let l,d,u,p,f,w=0,b=1e3/e,g=1/e,x=i?y:t,m=!0;function v(){if(d=requestAnimationFrame(v),m&&(u=performance.now(),p=u-l,l=u,!(p>1e3))){for(w+=p;w>=b;)r("tick"),f.update(g),w-=b;x(f.context),f.render()}}return c||(window.addEventListener("focus",(()=>{m=!0})),window.addEventListener("blur",(()=>{m=!1}))),a("init",(()=>{f.context??=o()})),f={update:s,render:h,isStopped:!0,context:n,start(){this.isStopped&&(l=performance.now(),this.isStopped=!1,requestAnimationFrame(v))},stop(){this.isStopped=!0,cancelAnimationFrame(d)}},f}({update:()=>{ge.update(),xe.update(),me.update(),ve.update(),Pe.update(),Ce.update(),ke.update()},render:()=>{ge.render(),xe.render(),me.render(),ve.render(),Pe.render(),Ce.render(),ke.render()}});Te.start();